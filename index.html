<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ðŸ“¦ DUR Ahafo Stores Management System</title>
  
  <!-- React & Dependencies -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/dexie@3/dist/dexie.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <!-- Google APIs -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <style>
    /* ============== BASE STYLES ============== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e7eb 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }
    
    /* ============== LAYOUT ============== */
    .app-container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
      overflow: hidden;
      min-height: 90vh;
      display: flex;
    }
    
    /* ============== SIDEBAR ============== */
    .sidebar {
      width: 280px;
      background: white;
      border-right: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      padding: 20px 0;
    }
    
    .sidebar-header {
      padding: 0 25px 25px;
      border-bottom: 1px solid #e0e0e0;
      margin-bottom: 25px;
    }
    
    .sidebar-brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 18px;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 10px;
    }
    
    .sidebar-brand .gradient-text {
      font-size: 28px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .sidebar-subtitle {
      font-size: 12px;
      color: #7f8c8d;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .sidebar-nav {
      flex: 1;
      padding: 0 15px;
    }
    
    .nav-section {
      margin-bottom: 30px;
    }
    
    .nav-section-title {
      font-size: 12px;
      color: #7f8c8d;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 15px;
      padding: 0 10px;
    }
    
    .nav-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 20px;
      color: #2c3e50;
      text-decoration: none;
      border-radius: 10px;
      margin-bottom: 8px;
      transition: all 0.3s ease;
      font-weight: 500;
      border-left: 4px solid transparent;
    }
    
    .nav-link:hover {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      color: #3498db;
      transform: translateX(5px);
    }
    
    .nav-link.active {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
      border-left-color: #1a5276;
    }
    
    .nav-link.active:hover {
      transform: none;
    }
    
    .sidebar-footer {
      padding: 20px 25px 0;
      border-top: 1px solid #e0e0e0;
      margin-top: auto;
    }
    
    .user-info-sidebar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 16px;
    }
    
    .user-details {
      flex: 1;
    }
    
    .user-name {
      font-weight: 600;
      color: #2c3e50;
      font-size: 14px;
    }
    
    .user-role {
      font-size: 12px;
      color: #7f8c8d;
      font-weight: 500;
    }
    
    .sidebar-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .sidebar-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 15px;
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      color: #2c3e50;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      text-align: left;
    }
    
    .sidebar-btn:hover {
      background: #e9ecef;
      border-color: #3498db;
      color: #3498db;
    }
    
    /* ============== MAIN CONTENT ============== */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .top-bar {
      padding: 20px 30px;
      background: white;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .page-title {
      font-size: 24px;
      font-weight: 700;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .top-bar-actions {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    /* ============== LOADING SCREEN ============== */
    .loading-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      color: white;
      text-align: center;
      padding: 40px;
      background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
    }
    
    .loading-logo {
      font-size: 80px;
      animation: bounce 2s infinite;
      margin-bottom: 20px;
      background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #4ecdc4;
      animation: spin 1s linear infinite;
      margin: 20px 0;
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ============== LOGIN SCREEN ============== */
    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
    }
    
    .login-box {
      background: white;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      width: 100%;
      max-width: 400px;
      animation: slideUp 0.5s ease;
      border: 3px solid #4ecdc4;
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .login-box h2 {
      text-align: center;
      margin-bottom: 30px;
      color: #1a237e;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-size: 24px;
    }
    
    /* ============== FORM CONTROLS ============== */
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #1a237e;
      font-weight: 600;
      font-size: 14px;
    }
    
    .form-control {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #c5cae9;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s;
      background: #f8f9fa;
      color: #1a237e;
    }
    
    .form-control:focus {
      outline: none;
      border-color: #4ecdc4;
      background: white;
      box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.2);
    }
    
    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: flex-end;
    }
    
    .form-row .form-group {
      flex: 1;
      min-width: 200px;
      margin-bottom: 0;
    }
    
    /* ============== BUTTONS ============== */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 12px rgba(78, 205, 196, 0.3);
      position: relative;
      overflow: hidden;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.6s;
    }
    
    .btn:hover::before {
      left: 100%;
    }
    
    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(78, 205, 196, 0.4), 0 0 20px rgba(78, 205, 196, 0.3);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn-logout {
      background: linear-gradient(135deg, #ff6b6b 0%, #ff4757 100%);
      box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
    }
    
    .btn-logout:hover {
      box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4), 0 0 20px rgba(255, 107, 107, 0.3);
    }
    
    .btn-add {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
    }
    
    .btn-add:hover {
      box-shadow: 0 8px 20px rgba(46, 204, 113, 0.4), 0 0 20px rgba(46, 204, 113, 0.3);
    }
    
    .btn-transaction {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
    }
    
    .btn-transaction:hover {
      box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4), 0 0 20px rgba(52, 152, 219, 0.3);
    }
    
    .btn-delete {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      padding: 8px 16px;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
    }
    
    .btn-delete:hover {
      box-shadow: 0 8px 20px rgba(231, 76, 60, 0.4), 0 0 20px rgba(231, 76, 60, 0.3);
    }
    
    .btn-edit {
      background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);
      color: #212529;
      padding: 8px 16px;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(241, 196, 15, 0.3);
    }
    
    .btn-edit:hover {
      box-shadow: 0 8px 20px rgba(241, 196, 15, 0.4), 0 0 20px rgba(241, 196, 15, 0.3);
    }
    
    .btn-export {
      background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
      box-shadow: 0 4px 12px rgba(155, 89, 182, 0.3);
    }
    
    .btn-export:hover {
      box-shadow: 0 8px 20px rgba(155, 89, 182, 0.4), 0 0 20px rgba(155, 89, 182, 0.3);
    }
    
    .btn-print {
      background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
      box-shadow: 0 4px 12px rgba(230, 126, 34, 0.3);
    }
    
    .btn-print:hover {
      box-shadow: 0 8px 20px rgba(230, 126, 34, 0.4), 0 0 20px rgba(230, 126, 34, 0.3);
    }
    
    .btn-save {
      background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);
      box-shadow: 0 4px 12px rgba(26, 188, 156, 0.3);
    }
    
    .btn-change-password {
      background: linear-gradient(135deg, #7f8c8d 0%, #34495e 100%);
      padding: 8px 16px;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(127, 140, 141, 0.3);
    }
    
    .btn-change-password:hover {
      box-shadow: 0 8px 20px rgba(127, 140, 141, 0.4), 0 0 20px rgba(127, 140, 141, 0.3);
    }
    
    .btn-import {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
    }
    
    .btn-import:hover {
      box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4), 0 0 20px rgba(52, 152, 219, 0.3);
    }
    
    .btn-download-template {
      background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
      box-shadow: 0 4px 12px rgba(149, 165, 166, 0.3);
    }
    
    .btn-download-template:hover {
      box-shadow: 0 8px 20px rgba(149, 165, 166, 0.4), 0 0 20px rgba(149, 165, 166, 0.3);
    }
    
    .google-btn {
      background: linear-gradient(135deg, #4285f4 0%, #0d47a1 100%);
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
    }
    
    .google-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(66, 133, 244, 0.4), 0 0 20px rgba(66, 133, 244, 0.3);
    }
    
    /* ============== CARDS ============== */
    .card {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border-radius: 15px;
      padding: 30px;
      margin: 25px 30px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      border: 1px solid #e0e0e0;
      position: relative;
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(0,0,0,0.2);
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: linear-gradient(90deg, #4ecdc4, #2ecc71);
    }
    
    .card h3 {
      color: #1a237e;
      margin-bottom: 25px;
      font-size: 22px;
      display: flex;
      align-items: center;
      gap: 12px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e0e0e0;
      font-weight: 700;
    }
    
    /* ============== TABLES ============== */
    .table-container {
      overflow-x: auto;
      margin-top: 20px;
      border-radius: 12px;
      border: 1px solid #e0e0e0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }
    
    th {
      background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
      padding: 18px;
      text-align: left;
      font-weight: 600;
      color: white;
      border-bottom: 3px solid #4ecdc4;
      position: sticky;
      top: 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 14px;
    }
    
    td {
      padding: 16px;
      border-bottom: 1px solid #e0e0e0;
      vertical-align: middle;
      color: #333;
    }
    
    tr {
      transition: all 0.3s ease;
    }
    
    tr:hover {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      transform: scale(1.002);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* ============== STATUS BADGES ============== */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: 25px;
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    
    .status-badge:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    
    .status-ok {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      color: white;
    }
    
    .status-low {
      background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);
      color: white;
    }
    
    .status-out {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
    }
    
    /* ============== ALERTS ============== */
    .alert {
      padding: 18px 24px;
      border-radius: 12px;
      margin: 20px 30px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      animation: slideIn 0.3s ease;
      box-shadow: 0 6px 12px rgba(0,0,0,0.1);
      border: 2px solid transparent;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .alert-success {
      background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
      color: #155724;
      border-color: #2ecc71;
    }
    
    .alert-error {
      background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
      color: #721c24;
      border-color: #e74c3c;
    }
    
    .alert-warning {
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
      color: #856404;
      border-color: #f1c40f;
    }
    
    .alert-info {
      background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
      color: #0c5460;
      border-color: #3498db;
    }
    
    .close-alert {
      background: none;
      border: none;
      font-size: 22px;
      cursor: pointer;
      color: inherit;
      opacity: 0.7;
      transition: opacity 0.2s;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    
    .close-alert:hover {
      opacity: 1;
      background: rgba(0,0,0,0.1);
    }
    
    /* ============== STATS GRID ============== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 25px;
      margin-bottom: 35px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      text-align: center;
      border: 1px solid #e0e0e0;
      transition: transform 0.3s, box-shadow 0.3s;
      position: relative;
      overflow: hidden;
    }
    
    .stat-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 15px 30px rgba(0,0,0,0.15), 0 0 20px rgba(78, 205, 196, 0.2);
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: linear-gradient(90deg, #4ecdc4, #2ecc71);
    }
    
    .stat-icon {
      font-size: 40px;
      margin-bottom: 15px;
      background: linear-gradient(135deg, #4ecdc4, #2ecc71);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .stat-value {
      font-size: 42px;
      font-weight: 800;
      margin: 15px 0;
      background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .stat-label {
      color: #666;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }
    
    /* ============== FILTER SECTIONS ============== */
    .filter-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 25px;
      border: 2px solid #e0e0e0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    
    .quick-filters {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    
    .quick-filter-btn {
      background: white;
      border: 2px solid #dee2e6;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
      font-weight: 500;
      color: #666;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .quick-filter-btn:hover {
      border-color: #4ecdc4;
      color: #4ecdc4;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(78, 205, 196, 0.2);
    }
    
    .quick-filter-btn.active {
      background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
      color: white;
      border-color: #4ecdc4;
      box-shadow: 0 4px 8px rgba(78, 205, 196, 0.3);
    }
    
    /* ============== MODALS ============== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease;
      backdrop-filter: blur(5px);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      padding: 35px;
      border-radius: 20px;
      min-width: 500px;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px rgba(0,0,0,0.3);
      animation: scaleIn 0.3s ease;
      border: 3px solid #4ecdc4;
      position: relative;
    }
    
    .modal::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: linear-gradient(90deg, #4ecdc4, #2ecc71);
    }
    
    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    
    /* ============== ACTION BUTTONS ============== */
    .action-buttons {
      display: flex;
      gap: 10px;
    }
    
    /* ============== DATE SELECTION ============== */
    .date-selection {
      position: relative;
    }
    
    .date-selection select {
      appearance: none;
      padding-right: 40px;
      cursor: pointer;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%231a237e' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
    }
    
    .date-indicator {
      position: absolute;
      right: 40px;
      top: 50%;
      transform: translateY(-50%);
      border-radius: 4px;
      padding: 3px 8px;
      font-size: 11px;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .date-indicator.start {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      color: white;
    }
    
    .date-indicator.end {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
    }
    
    .date-selected {
      font-size: 12px;
      margin-top: 5px;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 4px;
      display: inline-block;
    }
    
    .date-selected.start {
      background: rgba(46, 204, 113, 0.1);
      color: #27ae60;
    }
    
    .date-selected.end {
      background: rgba(231, 76, 60, 0.1);
      color: #c0392b;
    }
    
    /* ============== INFO BOXES ============== */
    .info-box {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      padding: 20px;
      border-radius: 12px;
      margin: 15px 0;
      border-left: 5px solid #3498db;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    
    .cost-info {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      border: 2px solid #e0e0e0;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    
    /* ============== REPORT CONTROLS ============== */
    .report-controls {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    
    .report-type-selector {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-bottom: 25px;
    }
    
    .report-type-btn {
      padding: 14px 28px;
      border: 2px solid #e0e0e0;
      background: white;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 10px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .report-type-btn:hover {
      border-color: #4ecdc4;
      color: #4ecdc4;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(78, 205, 196, 0.2);
    }
    
    .report-type-btn.active {
      background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
      color: white;
      border-color: #4ecdc4;
      box-shadow: 0 4px 12px rgba(78, 205, 196, 0.3);
    }
    
    /* ============== IMPORT SECTION ============== */
    .import-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 25px;
      border: 3px dashed #dee2e6;
    }
    
    .import-dropzone {
      padding: 50px;
      text-align: center;
      background: white;
      border-radius: 12px;
      border: 3px dashed #7f8c8d;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .import-dropzone:hover {
      border-color: #4ecdc4;
      background: #f8f9fa;
      transform: translateY(-3px);
      box-shadow: 0 8px 16px rgba(78, 205, 196, 0.2);
    }
    
    .import-dropzone.dragover {
      border-color: #2ecc71;
      background: #e8f6f3;
    }
    
    .import-preview {
      margin-top: 25px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .import-preview table {
      font-size: 13px;
    }
    
    .import-preview th,
    .import-preview td {
      padding: 10px;
    }
    
    /* ============== GOOGLE DRIVE SECTION ============== */
    .google-drive-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 25px;
      border: 2px solid #e0e0e0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    
    .google-status {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 20px;
      background: white;
      border: 2px solid #e0e0e0;
    }
    
    .google-status.connected {
      border-color: #34a853;
      background: rgba(52, 168, 83, 0.05);
    }
    
    .google-status.disconnected {
      border-color: #ea4335;
      background: rgba(234, 67, 53, 0.05);
    }
    
    .backup-controls {
      display: flex;
      gap: 15px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    
    .backup-history {
      margin-top: 25px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    /* ============== MULTI-SELECT FILTERS ============== */
    .multi-select-container {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    
    .multi-select-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      color: #666;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .multi-select-option:hover {
      border-color: #4ecdc4;
      color: #4ecdc4;
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(78, 205, 196, 0.2);
    }
    
    .multi-select-option.selected {
      background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
      color: white;
      border-color: #4ecdc4;
      box-shadow: 0 4px 12px rgba(78, 205, 196, 0.3);
    }
    
    .multi-select-option.selected .checkmark {
      display: block;
    }
    
    .checkmark {
      display: none;
      font-size: 14px;
    }
    
    /* ============== DATE RANGE FILTER ============== */
    .date-range-filter {
      display: flex;
      gap: 20px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    
    .date-input-group {
      flex: 1;
      min-width: 200px;
    }
    
    .date-input-group label {
      display: block;
      margin-bottom: 8px;
      color: #1a237e;
      font-weight: 600;
      font-size: 14px;
    }
    
    /* ============== GOOGLE DRIVE STATUS ============== */
    .drive-status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 10px;
    }
    
    .drive-status.connected {
      background: linear-gradient(135deg, #34a853 0%, #0d652d 100%);
      color: white;
      box-shadow: 0 4px 8px rgba(52, 168, 83, 0.3);
    }
    
    .drive-status.disconnected {
      background: linear-gradient(135deg, #ea4335 0%, #b71c1c 100%);
      color: white;
      box-shadow: 0 4px 8px rgba(234, 67, 53, 0.3);
    }
    
    /* ============== PRINT STYLES ============== */
    @media print {
      body * {
        visibility: hidden;
      }
      
      #print-section, #print-section * {
        visibility: visible;
      }
      
      #print-section {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        padding: 20px;
      }
      
      .no-print {
        display: none !important;
      }
      
      .print-only {
        display: block !important;
      }
      
      table {
        width: 100%;
        border-collapse: collapse;
      }
      
      th, td {
        border: 1px solid #000;
        padding: 10px;
      }
      
      .print-header {
        text-align: center;
        margin-bottom: 30px;
        border-bottom: 3px solid #000;
        padding-bottom: 15px;
      }
      
      .print-footer {
        text-align: center;
        margin-top: 30px;
        border-top: 2px solid #000;
        padding-top: 15px;
      }
    }
    
    .print-only {
      display: none;
    }
    
    /* ============== STORAGE STATUS ============== */
    .storage-status {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 15px 20px;
      border-radius: 12px;
      margin: 15px 30px;
      border: 2px solid #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    
    .storage-bar {
      flex: 1;
      height: 12px;
      background: #e9ecef;
      border-radius: 6px;
      overflow: hidden;
      margin: 0 20px;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .storage-fill {
      height: 100%;
      background: linear-gradient(90deg, #2ecc71, #27ae60);
      transition: width 0.3s ease-out;
      border-radius: 6px;
    }
    
    .storage-info {
      font-size: 13px;
      color: #666;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }
    
    /* ============== RESPONSIVE ============== */
    @media (max-width: 768px) {
      .app-container {
        flex-direction: column;
        border-radius: 15px;
      }
      
      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #e0e0e0;
        padding: 15px;
      }
      
      .main-content {
        width: 100%;
      }
      
      .top-bar {
        padding: 15px 20px;
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
      }
      
      .card {
        margin: 20px;
        padding: 25px;
      }
      
      .form-row {
        flex-direction: column;
      }
      
      .form-row .form-group {
        min-width: 100%;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .modal {
        min-width: 90%;
        margin: 10px;
        padding: 25px;
      }
    }
    
    /* ============== UTILITY CLASSES ============== */
    .text-success { color: #2ecc71; }
    .text-warning { color: #f1c40f; }
    .text-danger { color: #e74c3c; }
    .text-info { color: #3498db; }
    .text-muted { color: #7f8c8d; }
    
    .mb-20 { margin-bottom: 20px; }
    .mt-20 { margin-top: 20px; }
    .ml-10 { margin-left: 10px; }
    .mr-10 { margin-right: 10px; }
    
    /* ============== ANIMATIONS ============== */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .pulse {
      animation: pulse 2s infinite;
    }
    
    /* ============== GLOW EFFECTS ============== */
    .glow {
      box-shadow: 0 0 20px rgba(78, 205, 196, 0.5);
    }
    
    .glow-success {
      box-shadow: 0 0 20px rgba(46, 204, 113, 0.5);
    }
    
    .glow-warning {
      box-shadow: 0 0 20px rgba(241, 196, 15, 0.5);
    }
    
    .glow-danger {
      box-shadow: 0 0 20px rgba(231, 76, 60, 0.5);
    }
    
    /* ============== GRADIENT TEXT ============== */
    .gradient-text {
      background: linear-gradient(135deg, #4ecdc4, #2ecc71);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* ============== CHART CONTAINERS ============== */
    .chart-container {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      position: relative;
      height: 300px;
    }

    .chart-title {
      font-size: 16px;
      font-weight: 600;
      color: #1a237e;
      margin-bottom: 15px;
      text-align: center;
    }

    .dashboard-charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 25px 30px;
    }

    /* ============== MANUAL ENTRY TABLE ============== */
    .manual-entry-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .manual-entry-table th,
    .manual-entry-table td {
      padding: 10px;
      border: 1px solid #e0e0e0;
    }

    .manual-entry-table input {
      width: 100%;
      padding: 6px;
      border: 1px solid #c5cae9;
      border-radius: 4px;
    }

    .remove-row-btn {
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 12px;
    }

    .tab-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .tab-btn {
      padding: 10px 20px;
      background: #f8f9fa;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      color: #666;
      transition: all 0.3s;
    }

    .tab-btn.active {
      background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
      color: white;
      border-color: #4ecdc4;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    // ================= DATABASE SETUP =================
    const db = new Dexie("StoresDB_V2");
    
    db.version(1).stores({
      users: '++id,username,password,role,name',
      products: '++id,name,unit,reorderLevel,currentUnitCost,createdAt,updatedAt',
      movements: '++id,productId,type,quantity,date,reference,userId,unitCost,totalValue,importBatch',
      settings: 'key',
      backups: '++id,date,type,size,description,driveFileId,driveFileName',
      syncState: 'key,lastSync,lastBackup'
    });
    
    // ================= GOOGLE DRIVE INTEGRATION =================
    const GoogleDriveManager = {
      CLIENT_ID: '672283302745-js4344h9ghhq46mo7riiq799mpd3iaqs.apps.googleusercontent.com',
      API_KEY: 'AIzaSyD1PhCfMdRuz-40rOJvxDMi5o1UDauNDy0',
      SCOPES: 'https://www.googleapis.com/auth/drive.file',
      
      isInitialized: false,
      isSignedIn: false,
      
      async init() {
        return new Promise((resolve) => {
          if (this.isInitialized) {
            resolve(true);
            return;
          }
          
          try {
            if (!window.gapi) {
              console.error('Google API not loaded');
              resolve(false);
              return;
            }
            
            gapi.load('client', async () => {
              try {
                await gapi.client.init({
                  apiKey: this.API_KEY,
                  discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                });
                
                if (!window.google || !window.google.accounts) {
                  console.error('Google Identity Services not loaded');
                  resolve(false);
                  return;
                }
                
                // Check for existing token
                const token = localStorage.getItem('googleDriveToken');
                if (token) {
                  gapi.client.setToken(JSON.parse(token));
                  this.isSignedIn = true;
                }
                
                this.isInitialized = true;
                resolve(true);
              } catch (error) {
                console.error('Google API initialization error:', error);
                resolve(false);
              }
            });
          } catch (error) {
            console.error('Google Drive initialization error:', error);
            resolve(false);
          }
        });
      },
      
      async signIn() {
        try {
          const tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: this.CLIENT_ID,
            scope: this.SCOPES,
            callback: (response) => {
              if (response.access_token) {
                gapi.client.setToken(response);
                localStorage.setItem('googleDriveToken', JSON.stringify(response));
                this.isSignedIn = true;
                return true;
              }
              return false;
            },
          });
          
          tokenClient.requestAccessToken({ prompt: 'consent' });
          
          // Wait for callback
          return new Promise((resolve) => {
            setTimeout(() => resolve(this.isSignedIn), 1000);
          });
        } catch (error) {
          console.error('Sign in error:', error);
          return false;
        }
      },
      
      signOut() {
        const token = gapi.client.getToken();
        if (token) {
          google.accounts.oauth2.revoke(token.access_token);
          gapi.client.setToken(null);
        }
        localStorage.removeItem('googleDriveToken');
        this.isSignedIn = false;
      },
      
      async createBackup(data) {
        try {
          if (!this.isSignedIn) {
            throw new Error('Not signed in to Google Drive');
          }
          
          const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
          const filename = `DUR_Stores_Backup_${timestamp}.json`;
          
          const backupData = {
            app: 'DUR Ahafo Stores Management System',
            version: '1.0',
            timestamp: new Date().toISOString(),
            data: data
          };
          
          const fileContent = JSON.stringify(backupData, null, 2);
          
          const metadata = {
            name: filename,
            mimeType: 'application/json'
          };
          
          const form = new FormData();
          form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
          form.append('file', new Blob([fileContent], { type: 'application/json' }));
          
          const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${gapi.client.getToken().access_token}`
            },
            body: form
          });
          
          if (!response.ok) {
            throw new Error(`Backup failed: ${response.statusText}`);
          }
          
          const file = await response.json();
          
          await db.backups.add({
            date: new Date().toISOString(),
            type: 'manual',
            size: fileContent.length,
            description: `Backup to Google Drive: ${filename}`,
            driveFileId: file.id,
            driveFileName: file.name
          });
          
          return {
            success: true,
            filename: file.name,
            fileId: file.id
          };
        } catch (error) {
          console.error('Backup error:', error);
          return {
            success: false,
            error: error.message
          };
        }
      },
      
      async listBackups() {
        try {
          if (!this.isSignedIn) {
            return [];
          }
          
          const response = await gapi.client.drive.files.list({
            q: "name contains 'DUR_Stores_Backup_' and mimeType='application/json'",
            orderBy: 'createdTime desc',
            pageSize: 20
          });
          
          return response.result.files || [];
        } catch (error) {
          console.error('Error listing backups:', error);
          return [];
        }
      },
      
      async restoreBackup(fileId) {
        try {
          if (!this.isSignedIn) {
            throw new Error('Not signed in to Google Drive');
          }
          
          const response = await gapi.client.drive.files.get({
            fileId: fileId,
            alt: 'media'
          });
          
          return response.result;
        } catch (error) {
          console.error('Restore error:', error);
          throw error;
        }
      },
      
      async syncData(remoteData) {
        try {
          // Merge products - keep latest
          let mergedCount = 0;
          if (remoteData.products) {
            for (const remoteProduct of remoteData.products) {
              const localProduct = await db.products.get(remoteProduct.id);
              
              if (!localProduct) {
                await db.products.add(remoteProduct);
                mergedCount++;
              } else {
                const localDate = new Date(localProduct.updatedAt || localProduct.createdAt);
                const remoteDate = new Date(remoteProduct.updatedAt || remoteProduct.createdAt);
                
                if (remoteDate > localDate) {
                  await db.products.update(remoteProduct.id, remoteProduct);
                  mergedCount++;
                }
              }
            }
          }
          
          // Merge movements - add new ones only
          if (remoteData.movements) {
            const localMovementIds = new Set((await db.movements.toArray()).map(m => m.id));
            const newMovements = remoteData.movements.filter(m => !localMovementIds.has(m.id));
            
            if (newMovements.length > 0) {
              await db.movements.bulkAdd(newMovements);
              mergedCount += newMovements.length;
            }
          }
          
          return { success: true, merged: mergedCount };
        } catch (error) {
          console.error('Sync merge error:', error);
          return { success: false, error: error.message };
        }
      }
    };
    
    // ================= HELPER FUNCTIONS =================
    const helpers = {
      getProductBalance: (productId, movements) => {
        if (!movements || movements.length === 0) return 0;
        return movements
          .filter(m => m.productId === productId)
          .reduce((total, m) => m.type === 'IN' ? total + m.quantity : total - m.quantity, 0);
      },
      
      getProductStatus: (productId, products, movements) => {
        const product = products.find(p => p.id === productId);
        if (!product) return 'UNKNOWN';
        
        const balance = helpers.getProductBalance(productId, movements);
        if (balance === 0) return 'OUT';
        if (balance <= product.reorderLevel) return 'LOW';
        return 'OK';
      },
      
      formatCurrency: (amount) => {
        return new Intl.NumberFormat('en-GH', {
          style: 'currency',
          currency: 'GHS'
        }).format(amount);
      },
      
      formatDate: (date) => {
        return new Date(date).toLocaleDateString('en-GH', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      },
      
      formatDateShort: (date) => {
        return new Date(date).toLocaleDateString('en-GH', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
      },
      
      calculateProductCost: (productId, movements) => {
        const productMovements = movements.filter(m => m.productId === productId);
        const totalReceived = productMovements
          .filter(m => m.type === 'IN')
          .reduce((sum, m) => sum + (m.quantity * (m.unitCost || 0)), 0);
        
        const totalReceivedQuantity = productMovements
          .filter(m => m.type === 'IN')
          .reduce((sum, m) => sum + m.quantity, 0);
        
        const averageUnitCost = totalReceivedQuantity > 0 ? totalReceived / totalReceivedQuantity : 0;
        const currentStock = helpers.getProductBalance(productId, movements);
        const currentValue = currentStock * averageUnitCost;
        
        return {
          totalCost: totalReceived,
          averageUnitCost: averageUnitCost,
          currentStock: currentStock,
          currentValue: currentValue
        };
      },
      
      calculateStats: (products, movements) => {
        const totalProducts = products.length;
        const totalTransactions = movements.length;
        
        let lowStock = 0;
        let outOfStock = 0;
        let totalInventoryValue = 0;
        
        products.forEach(product => {
          const stock = helpers.getProductBalance(product.id, movements);
          const status = helpers.getProductStatus(product.id, products, movements);
          const costData = helpers.calculateProductCost(product.id, movements);
          
          if (status === 'LOW') lowStock++;
          if (status === 'OUT') outOfStock++;
          
          totalInventoryValue += costData.currentValue;
        });
        
        return {
          totalProducts,
          totalTransactions,
          lowStock,
          outOfStock,
          totalInventoryValue
        };
      },
      
      validatePassword: (password) => {
        if (password.length < 6) {
          return { valid: false, message: 'Password must be at least 6 characters' };
        }
        if (!/[A-Z]/.test(password)) {
          return { valid: false, message: 'Password must contain at least one uppercase letter' };
        }
        if (!/[0-9]/.test(password)) {
          return { valid: false, message: 'Password must contain at least one number' };
        }
        return { valid: true, message: 'Password is valid' };
      },
      
      generateImportTemplate: () => {
        const templateData = [
          {
            'Product Name': 'Laptop',
            'Unit': 'Piece',
            'Current Stock': '10',
            'Reorder Level': '5',
            'Average Unit Cost (GHÂ¢)': '800.00',
            'Total Cost of Purchases (GHÂ¢)': '8000.00',
            'Current Inventory Value (GHÂ¢)': '8000.00'
          },
          {
            'Product Name': 'Mouse',
            'Unit': 'Piece',
            'Current Stock': '50',
            'Reorder Level': '20',
            'Average Unit Cost (GHÂ¢)': '15.00',
            'Total Cost of Purchases (GHÂ¢)': '750.00',
            'Current Inventory Value (GHÂ¢)': '750.00'
          }
        ];
        
        const worksheet = XLSX.utils.json_to_sheet(templateData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Stock Import Template');
        XLSX.writeFile(workbook, 'Stock_Import_Template.xlsx');
      },
      
      exportToWord: (data, columns, title) => {
        // Create HTML content for Word
        let html = `
          <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
          <head>
            <meta charset="UTF-8">
            <title>${title}</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 20px; }
              h1 { color: #1a237e; text-align: center; }
              table { width: 100%; border-collapse: collapse; margin-top: 20px; }
              th { background: #1a237e; color: white; padding: 10px; text-align: left; }
              td { padding: 8px; border: 1px solid #ddd; }
              .header { text-align: center; margin-bottom: 30px; }
              .footer { text-align: center; margin-top: 30px; font-size: 12px; color: #666; }
              .date { text-align: right; margin-bottom: 20px; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>${title}</h1>
              <h3>DUR Ahafo Stores Management System</h3>
            </div>
            <div class="date">
              Generated on: ${new Date().toLocaleDateString('en-GH')} ${new Date().toLocaleTimeString('en-GH')}
            </div>
            <table>
              <thead>
                <tr>
                  ${columns.map(col => `<th>${col}</th>`).join('')}
                </tr>
              </thead>
              <tbody>
                ${data.map(row => `
                  <tr>
                    ${columns.map(col => `<td>${row[col] || ''}</td>`).join('')}
                  </tr>
                `).join('')}
              </tbody>
            </table>
            <div class="footer">
              <p>Â© ${new Date().getFullYear()} DUR Ahafo Stores Management System. All rights reserved.</p>
            </div>
          </body>
          </html>
        `;
        
        // Convert to blob and download
        const blob = new Blob(['\ufeff', html], {
          type: 'application/msword'
        });
        
        const filename = `${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.doc`;
        saveAs(blob, filename);
      }
    };
    
    // ================= INITIALIZE DATABASE =================
    async function initializeDatabase() {
      try {
        // Clear any existing data and start fresh
        await db.open();
        
        // Check if users exist
        let userCount = await db.users.count();
        
        if (userCount === 0) {
          console.log("Creating default users...");
          await db.users.bulkAdd([
            { 
              username: "storekeeper", 
              password: "Store123", 
              role: "STOREKEEPER", 
              name: "Store Manager" 
            },
            { 
              username: "supervisor", 
              password: "Super123", 
              role: "SUPERVISOR", 
              name: "Supervisor" 
            },
            { 
              username: "admin", 
              password: "Admin123", 
              role: "ADMIN", 
              name: "Administrator" 
            }
          ]);
          console.log("Default users created successfully");
        }
        
        // Check if products exist
        let productCount = await db.products.count();
        if (productCount === 0) {
          const now = new Date().toISOString();
          await db.products.bulkAdd([
            { 
              name: "Laptop", 
              unit: "Piece", 
              reorderLevel: 5, 
              currentUnitCost: 800, 
              createdAt: now, 
              updatedAt: now 
            },
            { 
              name: "Mouse", 
              unit: "Piece", 
              reorderLevel: 20, 
              currentUnitCost: 15, 
              createdAt: now, 
              updatedAt: now 
            },
            { 
              name: "Keyboard", 
              unit: "Piece", 
              reorderLevel: 15, 
              currentUnitCost: 45, 
              createdAt: now, 
              updatedAt: now 
            },
            { 
              name: "Monitor", 
              unit: "Piece", 
              reorderLevel: 8, 
              currentUnitCost: 200, 
              createdAt: now, 
              updatedAt: now 
            }
          ]);
        }
        
        return true;
      } catch (error) {
        console.error("Database initialization error:", error);
        
        // Try to delete and recreate database
        try {
          await db.delete();
          await db.open();
          return initializeDatabase();
        } catch (retryError) {
          console.error("Failed to recreate database:", retryError);
          return false;
        }
      }
    }
    
    // ================= BACKUP & SYNC COMPONENT (UPDATED) =================
    function BackupSync({ showAlert, onClose }) {
      const [driveStatus, setDriveStatus] = React.useState({
        initialized: false,
        signedIn: false,
        loading: false
      });
      const [backups, setBackups] = React.useState([]);
      const [syncing, setSyncing] = React.useState(false);
      const [importModal, setImportModal] = React.useState({ show: false, fileId: null, fileName: '' });

      React.useEffect(() => {
        initializeDrive();
      }, []);

      const initializeDrive = async () => {
        try {
          setDriveStatus(prev => ({ ...prev, loading: true }));
          const initialized = await GoogleDriveManager.init();

          setDriveStatus({
            initialized,
            signedIn: GoogleDriveManager.isSignedIn,
            loading: false
          });

          if (GoogleDriveManager.isSignedIn) {
            loadBackups();
          }
        } catch (error) {
          console.error('Drive initialization error:', error);
          setDriveStatus({
            initialized: false,
            signedIn: false,
            loading: false
          });
        }
      };

      const handleSignIn = async () => {
        try {
          setDriveStatus(prev => ({ ...prev, loading: true }));
          const success = await GoogleDriveManager.signIn();

          if (success) {
            setDriveStatus({
              initialized: true,
              signedIn: true,
              loading: false
            });
            showAlert('Successfully connected to Google Drive', 'success');
            loadBackups();
          } else {
            setDriveStatus(prev => ({ ...prev, loading: false }));
            showAlert('Failed to connect to Google Drive', 'error');
          }
        } catch (error) {
          console.error('Sign in error:', error);
          setDriveStatus(prev => ({ ...prev, loading: false }));
          showAlert('Error connecting to Google Drive', 'error');
        }
      };

      const handleSignOut = () => {
        GoogleDriveManager.signOut();
        setDriveStatus({
          initialized: true,
          signedIn: false,
          loading: false
        });
        setBackups([]);
        showAlert('Disconnected from Google Drive', 'info');
      };

      const loadBackups = async () => {
        try {
          setDriveStatus(prev => ({ ...prev, loading: true }));
          const driveBackups = await GoogleDriveManager.listBackups();
          setBackups(driveBackups);
          showAlert(`Found ${driveBackups.length} backup(s)`, 'success');
        } catch (error) {
          console.error('Error loading backups:', error);
          showAlert('Failed to load backups', 'error');
        } finally {
          setDriveStatus(prev => ({ ...prev, loading: false }));
        }
      };

      const handleBackup = async () => {
        try {
          setDriveStatus(prev => ({ ...prev, loading: true }));

          const data = {
            products: await db.products.toArray(),
            movements: await db.movements.toArray(),
            users: await db.users.toArray()
          };

          const result = await GoogleDriveManager.createBackup(data);

          if (result.success) {
            showAlert(`âœ… Backup created successfully: ${result.filename}`, 'success');
            loadBackups(); // refresh list
          } else {
            showAlert(`âŒ Backup failed: ${result.error}`, 'error');
          }
        } catch (error) {
          console.error('Backup error:', error);
          showAlert('Error creating backup', 'error');
        } finally {
          setDriveStatus(prev => ({ ...prev, loading: false }));
        }
      };

      // New function: Import from backup with options
      const handleImport = async (fileId, fileName, mode) => {
        try {
          setDriveStatus(prev => ({ ...prev, loading: true }));

          const backupData = await GoogleDriveManager.restoreBackup(fileId);
          if (!backupData || !backupData.data) {
            throw new Error('Invalid backup file format');
          }

          if (mode === 'replace') {
            // Replace all data
            await db.products.clear();
            await db.movements.clear();
            await db.users.clear();
            await db.backups.clear();

            if (backupData.data.products) {
              await db.products.bulkAdd(backupData.data.products);
            }
            if (backupData.data.movements) {
              await db.movements.bulkAdd(backupData.data.movements);
            }
            if (backupData.data.users) {
              await db.users.bulkAdd(backupData.data.users);
            }

            showAlert('âœ… Data replaced successfully! Page will reload...', 'success');
          } else {
            // Merge: add missing records, update existing based on timestamp
            const result = await GoogleDriveManager.syncData(backupData.data);
            if (result.success) {
              showAlert(`âœ… Merge completed. Merged ${result.merged || 0} new/updated records.`, 'success');
            } else {
              throw new Error(result.error);
            }
          }

          // Trigger data reload
          window.dispatchEvent(new CustomEvent('dataChanged'));

          // For replace, reload page after a short delay
          if (mode === 'replace') {
            setTimeout(() => window.location.reload(), 2000);
          } else {
            setImportModal({ show: false, fileId: null, fileName: '' });
          }
        } catch (error) {
          console.error('Import error:', error);
          showAlert(`âŒ Import failed: ${error.message}`, 'error');
        } finally {
          setDriveStatus(prev => ({ ...prev, loading: false }));
        }
      };

      const handleSync = async () => {
        try {
          setSyncing(true);

          const driveBackups = await GoogleDriveManager.listBackups();
          if (driveBackups.length === 0) {
            showAlert('No backups found. Create a backup first.', 'warning');
            setSyncing(false);
            return;
          }

          const latestBackup = driveBackups[0];
          showAlert(`Syncing with: ${latestBackup.name}`, 'info');

          const backupData = await GoogleDriveManager.restoreBackup(latestBackup.id);
          if (!backupData || !backupData.data) {
            showAlert('Invalid backup file format', 'error');
            setSyncing(false);
            return;
          }

          const result = await GoogleDriveManager.syncData(backupData.data);

          if (result.success) {
            showAlert(`âœ… Sync completed. Merged ${result.merged || 0} new records.`, 'success');
            window.dispatchEvent(new CustomEvent('dataChanged'));
          } else {
            showAlert(`âŒ Sync failed: ${result.error}`, 'error');
          }
        } catch (error) {
          console.error('Sync error:', error);
          showAlert('Error synchronizing data', 'error');
        } finally {
          setSyncing(false);
        }
      };

      const handleRestore = async (fileId, filename) => {
        if (!window.confirm(`Are you sure you want to restore from backup:\n${filename}?\n\nThis will replace all local data.`)) {
          return;
        }
        // Call import with replace mode
        await handleImport(fileId, filename, 'replace');
      };

      return (
        <div className="google-drive-section">
          <h4 style={{ color: '#1a237e', marginBottom: '20px' }}>
            <span className="gradient-text">â˜ï¸</span> Google Drive Backup & Import
          </h4>

          {/* Multi-user note */}
          <div className="info-box" style={{ marginBottom: '20px', background: '#e3f2fd', borderLeftColor: '#2196f3' }}>
            <strong>ðŸ’¡ Multiâ€‘User Sync:</strong> To share data between computers, create a backup on one, then on another computer use <strong>Import</strong> (choose replace or merge). 
            Make sure all users have access to the same Google Drive account.
          </div>

          <div className={`google-status ${driveStatus.signedIn ? 'connected' : 'disconnected'}`}>
            <div style={{ 
              width: '12px', 
              height: '12px', 
              borderRadius: '50%',
              background: driveStatus.signedIn ? '#34a853' : '#ea4335',
              boxShadow: `0 0 10px ${driveStatus.signedIn ? '#34a853' : '#ea4335'}`
            }}></div>
            <div>
              <strong>Status:</strong> {driveStatus.signedIn ? 'Connected to Google Drive' : 'Not Connected'}
            </div>
          </div>

          {!driveStatus.initialized || driveStatus.loading ? (
            <div style={{ textAlign: 'center', padding: '20px' }}>
              <div className="loading-spinner" style={{ width: '30px', height: '30px', margin: '0 auto' }}></div>
              <p style={{ marginTop: '10px', color: '#666' }}>Initializing Google Drive...</p>
            </div>
          ) : !driveStatus.signedIn ? (
            <div style={{ textAlign: 'center' }}>
              <button 
                className="google-btn"
                onClick={handleSignIn}
                disabled={driveStatus.loading}
              >
                <span>ðŸ”</span> Sign in with Google
              </button>
              <p style={{ marginTop: '15px', fontSize: '14px', color: '#666' }}>
                Connect to Google Drive to enable backups and data import.
              </p>
            </div>
          ) : (
            <div>
              <div className="backup-controls">
                <button 
                  className="btn btn-add"
                  onClick={handleBackup}
                  disabled={driveStatus.loading}
                >
                  <span>ðŸ’¾</span> Create Backup
                </button>

                <button 
                  className="btn btn-transaction"
                  onClick={handleSync}
                  disabled={syncing || driveStatus.loading}
                >
                  <span>ðŸ”„</span> {syncing ? 'Syncing...' : 'Auto-Merge Sync'}
                </button>

                <button 
                  className="btn btn-export"
                  onClick={loadBackups}
                  disabled={driveStatus.loading}
                >
                  <span>ðŸ”„</span> Refresh Backups
                </button>
              </div>

              {backups.length > 0 && (
                <div className="backup-history">
                  <h5 style={{ color: '#1a237e', marginBottom: '15px' }}>Available Backups:</h5>
                  <div className="table-container">
                    <table>
                      <thead>
                        <tr>
                          <th>Backup File</th>
                          <th>Created</th>
                          <th>Size</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        {backups.slice(0, 10).map(backup => (
                          <tr key={backup.id}>
                            <td>{backup.name}</td>
                            <td>{new Date(backup.createdTime).toLocaleString()}</td>
                            <td>{backup.size ? `${(backup.size / 1024).toFixed(2)} KB` : 'Unknown'}</td>
                            <td>
                              <div className="action-buttons">
                                <button 
                                  onClick={() => handleRestore(backup.id, backup.name)}
                                  className="btn btn-edit"
                                  style={{ padding: '6px 12px', fontSize: '13px' }}
                                >
                                  <span>ðŸ“¥</span> Replace All
                                </button>
                                <button 
                                  onClick={() => handleImport(backup.id, backup.name, 'merge')}
                                  className="btn btn-transaction"
                                  style={{ padding: '6px 12px', fontSize: '13px' }}
                                >
                                  <span>ðŸ”„</span> Merge
                                </button>
                              </div>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                  <p style={{ fontSize: '12px', color: '#666', marginTop: '10px' }}>
                    <strong>Replace All</strong> â€“ overwrites all local data with the backup.<br/>
                    <strong>Merge</strong> â€“ adds new records and updates existing ones based on timestamps.
                  </p>
                </div>
              )}
            </div>
          )}

          <div style={{ display: 'flex', justifyContent: 'center', marginTop: '25px' }}>
            <button 
              onClick={onClose}
              className="btn"
              style={{ background: 'linear-gradient(135deg, #7f8c8d 0%, #34495e 100%)' }}
            >
              <span>â†©ï¸</span> Close
            </button>
          </div>
        </div>
      );
    }
    
    // ================= LOADING COMPONENT =================
    function LoadingScreen() {
      return (
        <div className="loading-screen">
          <div className="loading-logo">ðŸ“¦</div>
          <h2 className="gradient-text" style={{ fontSize: '28px', marginBottom: '10px' }}>DUR Ahafo Stores Management System</h2>
          <div className="loading-spinner"></div>
          <p style={{ marginTop: '10px', fontSize: '14px', opacity: 0.7, color: '#e0e0e0' }}>
            Initializing system...
          </p>
        </div>
      );
    }
    
    // ================= SIDEBAR COMPONENT =================
    function Sidebar({ activeView, setActiveView, user, logout, setShowChangePasswordModal, setShowBackupModal }) {
      const getUserInitials = (name) => {
        return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
      };
      
      return (
        <div className="sidebar">
          <div className="sidebar-header">
            <div className="sidebar-brand">
              <span className="gradient-text">ðŸ“¦</span>
              <h2>DUR Ahafo Stores</h2>
            </div>
            <div className="sidebar-subtitle">Management System</div>
          </div>
          
          <div className="sidebar-nav">
            <div className="nav-section">
              <div className="nav-section-title">Main Menu</div>
              <a 
                className={`nav-link ${activeView === 'dashboard' ? 'active' : ''}`}
                onClick={() => setActiveView('dashboard')}
              >
                <span>ðŸ“Š</span> Dashboard
              </a>
              <a 
                className={`nav-link ${activeView === 'products' ? 'active' : ''}`}
                onClick={() => setActiveView('products')}
              >
                <span>ðŸ“¦</span> Products
              </a>
              {(user.role === 'STOREKEEPER' || user.role === 'ADMIN') && (
                <a 
                  className={`nav-link ${activeView === 'transactions' ? 'active' : ''}`}
                  onClick={() => setActiveView('transactions')}
                >
                  <span>ðŸ’°</span> Transactions
                </a>
              )}
              <a 
                className={`nav-link ${activeView === 'history' ? 'active' : ''}`}
                onClick={() => setActiveView('history')}
              >
                <span>ðŸ“‹</span> History
              </a>
              <a 
                className={`nav-link ${activeView === 'reports' ? 'active' : ''}`}
                onClick={() => setActiveView('reports')}
              >
                <span>ðŸ“ˆ</span> Reports
              </a>
            </div>
            
            {user.role === 'ADMIN' && (
              <div className="nav-section">
                <div className="nav-section-title">Administration</div>
                <a 
                  className={`nav-link ${activeView === 'users' ? 'active' : ''}`}
                  onClick={() => setActiveView('users')}
                >
                  <span>ðŸ‘¥</span> Users
                </a>
              </div>
            )}
          </div>
          
          <div className="sidebar-footer">
            <div className="user-info-sidebar">
              <div className="user-avatar">{getUserInitials(user.name)}</div>
              <div className="user-details">
                <div className="user-name">{user.name}</div>
                <div className="user-role">{user.role}</div>
              </div>
            </div>
            
            <div className="sidebar-actions">
              <button 
                className="sidebar-btn"
                onClick={() => setShowChangePasswordModal(true)}
              >
                <span>ðŸ”’</span> Change Password
              </button>
              <button 
                className="sidebar-btn"
                onClick={() => setShowBackupModal(true)}
              >
                <span>â˜ï¸</span> Backup/Sync
              </button>
              <button 
                className="sidebar-btn"
                onClick={logout}
                style={{ color: '#e74c3c' }}
              >
                <span>ðŸšª</span> Logout
              </button>
            </div>
          </div>
        </div>
      );
    }
    
    // ================= CHART DETAILS MODAL =================
    function ChartDetailsModal({ title, products, onClose }) {
      return (
        <div className="modal-overlay">
          <div className="modal" style={{ maxWidth: '800px' }}>
            <h3><span className="gradient-text">ðŸ“Š</span> {title}</h3>
            <div className="table-container">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Unit</th>
                    <th>Current Stock</th>
                    <th>Reorder Level</th>
                    <th>Total Cost (GHÂ¢)</th>
                    <th>Avg Cost (GHÂ¢)</th>
                    <th>Current Value (GHÂ¢)</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {products.map(p => (
                    <tr key={p.id}>
                      <td>{p.id}</td>
                      <td>{p.name}</td>
                      <td>{p.unit}</td>
                      <td>{p.stock}</td>
                      <td>{p.reorderLevel}</td>
                      <td>{helpers.formatCurrency(p.totalCost || 0)}</td>
                      <td>{helpers.formatCurrency(p.avgCost || 0)}</td>
                      <td>{helpers.formatCurrency(p.currentValue || 0)}</td>
                      <td>
                        <span className={`status-badge status-${p.status.toLowerCase()}`}>
                          {p.status === 'OUT' ? 'ðŸ›‘ Out' : p.status === 'LOW' ? 'âš ï¸ Low' : 'âœ“ OK'}
                        </span>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            <div style={{ display: 'flex', justifyContent: 'center', marginTop: '20px' }}>
              <button onClick={onClose} className="btn" style={{ background: 'linear-gradient(135deg, #7f8c8d 0%, #34495e 100%)' }}>
                <span>â†©ï¸</span> Close
              </button>
            </div>
          </div>
        </div>
      );
    }
    
    // ================= DASHBOARD CHARTS =================
    function DashboardCharts({ products, movements, helpers, onSliceClick }) {
      const donutChartRef = React.useRef(null);
      const barChartRef = React.useRef(null);
      const donutInstance = React.useRef(null);
      const barInstance = React.useRef(null);
      
      // Compute status counts
      const statusCounts = {
        OK: products.filter(p => helpers.getProductStatus(p.id, products, movements) === 'OK').length,
        LOW: products.filter(p => helpers.getProductStatus(p.id, products, movements) === 'LOW').length,
        OUT: products.filter(p => helpers.getProductStatus(p.id, products, movements) === 'OUT').length
      };
      
      // Compute top 10 products by current value
      const topProducts = products
        .map(p => {
          const stock = helpers.getProductBalance(p.id, movements);
          const costData = helpers.calculateProductCost(p.id, movements);
          return {
            ...p,
            stock,
            value: costData.currentValue,
            status: helpers.getProductStatus(p.id, products, movements),
            totalCost: costData.totalCost,
            avgCost: costData.averageUnitCost,
            currentValue: costData.currentValue
          };
        })
        .sort((a, b) => b.value - a.value)
        .slice(0, 10);
      
      React.useEffect(() => {
        // Donut chart
        if (donutChartRef.current) {
          if (donutInstance.current) donutInstance.current.destroy();
          
          donutInstance.current = new Chart(donutChartRef.current, {
            type: 'doughnut',
            data: {
              labels: ['In Stock', 'Low Stock', 'Out of Stock'],
              datasets: [{
                data: [statusCounts.OK, statusCounts.LOW, statusCounts.OUT],
                backgroundColor: ['#2ecc71', '#f1c40f', '#e74c3c'],
                borderColor: '#fff',
                borderWidth: 2,
                hoverOffset: 8
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' },
                tooltip: { callbacks: { label: (ctx) => `${ctx.raw} products` } }
              },
              onClick: (event, elements) => {
                if (elements.length > 0) {
                  const index = elements[0].index;
                  const statusMap = ['OK', 'LOW', 'OUT'];
                  const status = statusMap[index];
                  const filtered = products
                    .map(p => {
                      const stock = helpers.getProductBalance(p.id, movements);
                      const costData = helpers.calculateProductCost(p.id, movements);
                      return {
                        ...p,
                        stock,
                        status: helpers.getProductStatus(p.id, products, movements),
                        totalCost: costData.totalCost,
                        avgCost: costData.averageUnitCost,
                        currentValue: costData.currentValue
                      };
                    })
                    .filter(p => p.status === status);
                  onSliceClick(`${status === 'OK' ? 'In Stock' : status === 'LOW' ? 'Low Stock' : 'Out of Stock'} Products`, filtered);
                }
              }
            }
          });
        }
        
        // Bar chart
        if (barChartRef.current) {
          if (barInstance.current) barInstance.current.destroy();
          
          barInstance.current = new Chart(barChartRef.current, {
            type: 'bar',
            data: {
              labels: topProducts.map(p => p.name.length > 15 ? p.name.substring(0, 12) + '...' : p.name),
              datasets: [{
                label: 'Current Value (GHÂ¢)',
                data: topProducts.map(p => p.value),
                backgroundColor: 'rgba(52, 152, 219, 0.8)',
                borderColor: '#2980b9',
                borderWidth: 1,
                borderRadius: 5
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: { callbacks: { label: (ctx) => `Value: ${helpers.formatCurrency(ctx.raw)}` } }
              },
              scales: {
                y: { beginAtZero: true, ticks: { callback: (val) => helpers.formatCurrency(val) } }
              },
              onClick: (event, elements) => {
                if (elements.length > 0) {
                  const index = elements[0].index;
                  const product = topProducts[index];
                  onSliceClick(`Product: ${product.name}`, [product]);
                }
              }
            }
          });
        }
        
        return () => {
          if (donutInstance.current) donutInstance.current.destroy();
          if (barInstance.current) barInstance.current.destroy();
        };
      }, [products, movements]);
      
      return (
        <div className="dashboard-charts-grid">
          <div className="chart-container">
            <div className="chart-title">Stock Status Distribution</div>
            <canvas ref={donutChartRef}></canvas>
          </div>
          <div className="chart-container">
            <div className="chart-title">Top 10 Products by Inventory Value</div>
            <canvas ref={barChartRef}></canvas>
          </div>
        </div>
      );
    }
    
    // ================= ADD PRODUCTS RECORDS MODAL =================
    function AddProductsRecordsModal({ onClose, onSave, products, helpers, showAlert }) {
      const [activeTab, setActiveTab] = React.useState('manual');
      const [manualRows, setManualRows] = React.useState([
        { id: Date.now(), name: '', unit: '', currentStock: '', reorderLevel: '', avgUnitCost: '' }
      ]);
      const [importData, setImportData] = React.useState([]);
      const [importErrors, setImportErrors] = React.useState([]);
      const fileInputRef = React.useRef(null);
      
      const maxId = Math.max(...products.map(p => p.id), 0);
      
      const addRow = () => {
        setManualRows([...manualRows, { id: Date.now() + Math.random(), name: '', unit: '', currentStock: '', reorderLevel: '', avgUnitCost: '' }]);
      };
      
      const removeRow = (rowId) => {
        if (manualRows.length > 1) {
          setManualRows(manualRows.filter(r => r.id !== rowId));
        }
      };
      
      const updateRow = (rowId, field, value) => {
        setManualRows(manualRows.map(r => r.id === rowId ? { ...r, [field]: value } : r));
      };
      
      const handleManualSubmit = async () => {
        // Validate rows
        const errors = [];
        manualRows.forEach((row, idx) => {
          if (!row.name.trim()) errors.push(`Row ${idx+1}: Product name is required`);
          if (!row.unit.trim()) errors.push(`Row ${idx+1}: Unit is required`);
          if (!row.currentStock || isNaN(row.currentStock) || parseInt(row.currentStock) < 0) 
            errors.push(`Row ${idx+1}: Current Stock must be a non-negative number`);
          if (!row.reorderLevel || isNaN(row.reorderLevel) || parseInt(row.reorderLevel) < 0)
            errors.push(`Row ${idx+1}: Reorder Level must be a non-negative number`);
          if (row.avgUnitCost && (isNaN(row.avgUnitCost) || parseFloat(row.avgUnitCost) < 0))
            errors.push(`Row ${idx+1}: Average Unit Cost must be a non-negative number`);
        });
        
        if (errors.length > 0) {
          alert('Please fix the following errors:\n' + errors.join('\n'));
          return;
        }
        
        try {
          for (const row of manualRows) {
            // Add product
            const productId = await db.products.add({
              name: row.name.trim(),
              unit: row.unit.trim(),
              reorderLevel: parseInt(row.reorderLevel) || 0,
              currentUnitCost: parseFloat(row.avgUnitCost) || 0,
              createdAt: new Date().toISOString(),
              updatedAt: new Date().toISOString()
            });
            
            // Add initial stock movement
            if (parseInt(row.currentStock) > 0) {
              await db.movements.add({
                productId: productId,
                type: 'IN',
                quantity: parseInt(row.currentStock),
                unitCost: parseFloat(row.avgUnitCost) || 0,
                reference: 'INITIAL_STOCK',
                date: new Date().toISOString(),
                userId: null, // system user
                totalValue: parseInt(row.currentStock) * (parseFloat(row.avgUnitCost) || 0),
                importBatch: `MANUAL_${Date.now()}`
              });
            }
          }
          
          showAlert(`${manualRows.length} products added successfully`, 'success');
          window.dispatchEvent(new CustomEvent('dataChanged'));
          onClose();
        } catch (error) {
          console.error('Error saving manual entries:', error);
          showAlert('Error saving products', 'error');
        }
      };
      
      const handleFileSelect = (event) => {
        const file = event.target.files[0];
        if (file) {
          readExcelFile(file);
        }
      };
      
      const readExcelFile = (file) => {
        const reader = new FileReader();
        
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet);
            
            const processedData = [];
            const errors = [];
            
            jsonData.forEach((row, index) => {
              const rowNumber = index + 2;
              
              if (!row['Product Name']) {
                errors.push(`Row ${rowNumber}: Missing product name`);
                return;
              }
              
              const productName = row['Product Name'].toString().trim();
              const unit = row['Unit'] || 'Piece';
              const currentStock = parseInt(row['Current Stock'] || 0);
              const reorderLevel = parseInt(row['Reorder Level'] || 0);
              const averageUnitCost = parseFloat(row['Average Unit Cost (GHÂ¢)'] || row['Average Unit Cost'] || 0);
              
              if (isNaN(currentStock) || currentStock < 0) {
                errors.push(`Row ${rowNumber}: Invalid current stock`);
                return;
              }
              
              if (isNaN(reorderLevel) || reorderLevel < 0) {
                errors.push(`Row ${rowNumber}: Invalid reorder level`);
                return;
              }
              
              if (isNaN(averageUnitCost) || averageUnitCost < 0) {
                errors.push(`Row ${rowNumber}: Invalid average unit cost`);
                return;
              }
              
              // Check if product already exists
              const existingProduct = products.find(p => 
                p.name.toLowerCase() === productName.toLowerCase()
              );
              
              if (existingProduct) {
                errors.push(`Row ${rowNumber}: Product "${productName}" already exists`);
                return;
              }
              
              processedData.push({
                productName,
                unit,
                currentStock,
                reorderLevel,
                averageUnitCost,
                totalCost: (currentStock * averageUnitCost).toFixed(2),
                currentValue: (currentStock * averageUnitCost).toFixed(2)
              });
            });
            
            setImportData(processedData);
            setImportErrors(errors);
            
          } catch (error) {
            console.error("Error reading Excel file:", error);
            alert('Error reading file. Please make sure it is a valid Excel file.');
          }
        };
        
        reader.readAsArrayBuffer(file);
      };
      
      const handleImportSubmit = async () => {
        if (importData.length === 0) {
          alert('No valid data to import');
          return;
        }
        
        try {
          for (const item of importData) {
            const productId = await db.products.add({
              name: item.productName,
              unit: item.unit,
              reorderLevel: item.reorderLevel,
              currentUnitCost: item.averageUnitCost,
              createdAt: new Date().toISOString(),
              updatedAt: new Date().toISOString()
            });
            
            if (item.currentStock > 0) {
              await db.movements.add({
                productId: productId,
                type: 'IN',
                quantity: item.currentStock,
                unitCost: item.averageUnitCost,
                reference: 'STOCK_IMPORT',
                date: new Date().toISOString(),
                userId: null,
                totalValue: item.currentStock * item.averageUnitCost,
                importBatch: `IMPORT_${Date.now()}`
              });
            }
          }
          
          showAlert(`${importData.length} products imported successfully`, 'success');
          window.dispatchEvent(new CustomEvent('dataChanged'));
          onClose();
        } catch (error) {
          console.error('Error importing products:', error);
          showAlert('Error importing products', 'error');
        }
      };
      
      return (
        <div className="modal-overlay">
          <div className="modal" style={{ maxWidth: '1000px' }}>
            <h3><span className="gradient-text">âž•</span> Add Products Records</h3>
            
            <div className="tab-buttons">
              <button className={`tab-btn ${activeTab === 'manual' ? 'active' : ''}`} onClick={() => setActiveTab('manual')}>
                Manual Entry
              </button>
              <button className={`tab-btn ${activeTab === 'import' ? 'active' : ''}`} onClick={() => setActiveTab('import')}>
                Import Excel
              </button>
            </div>
            
            {activeTab === 'manual' && (
              <div>
                <p style={{ marginBottom: '15px', color: '#1a237e' }}>
                  Enter product details below. ID will be auto-generated (starting from {maxId + 1}).
                </p>
                <div style={{ maxHeight: '400px', overflowY: 'auto' }}>
                  <table className="manual-entry-table">
                    <thead>
                      <tr>
                        <th>#</th>
                        <th>Name</th>
                        <th>Unit</th>
                        <th>Current Stock</th>
                        <th>Reorder Level</th>
                        <th>Avg Unit Cost (GHÂ¢)</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      {manualRows.map((row, idx) => (
                        <tr key={row.id}>
                          <td>{maxId + idx + 1}</td>
                          <td><input type="text" value={row.name} onChange={e => updateRow(row.id, 'name', e.target.value)} placeholder="Name" /></td>
                          <td><input type="text" value={row.unit} onChange={e => updateRow(row.id, 'unit', e.target.value)} placeholder="Unit" /></td>
                          <td><input type="number" value={row.currentStock} onChange={e => updateRow(row.id, 'currentStock', e.target.value)} min="0" /></td>
                          <td><input type="number" value={row.reorderLevel} onChange={e => updateRow(row.id, 'reorderLevel', e.target.value)} min="0" /></td>
                          <td><input type="number" step="0.01" value={row.avgUnitCost} onChange={e => updateRow(row.id, 'avgUnitCost', e.target.value)} min="0" /></td>
                          <td>
                            {manualRows.length > 1 && (
                              <button className="remove-row-btn" onClick={() => removeRow(row.id)}>âœ–</button>
                            )}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
                <div style={{ display: 'flex', gap: '10px', marginTop: '15px' }}>
                  <button className="btn btn-add" onClick={addRow}>
                    <span>âž•</span> Add Row
                  </button>
                </div>
              </div>
            )}
            
            {activeTab === 'import' && (
              <div className="import-section">
                <div style={{ textAlign: 'center', padding: '30px' }}>
                  <button className="btn btn-import" onClick={() => fileInputRef.current.click()} style={{ padding: '15px 30px' }}>
                    <span>ðŸ“„</span> Select Excel File
                  </button>
                  <input type="file" ref={fileInputRef} style={{ display: 'none' }} accept=".xlsx,.xls" onChange={handleFileSelect} />
                  <p style={{ marginTop: '15px', fontSize: '13px', color: '#666' }}>
                    Required columns: Product Name, Unit, Current Stock, Reorder Level, Average Unit Cost (GHÂ¢)
                  </p>
                </div>
                
                {importData.length > 0 && (
                  <div className="import-preview">
                    <h5 style={{ color: '#1a237e' }}>Preview ({importData.length} products)</h5>
                    <div className="table-container">
                      <table>
                        <thead>
                          <tr>
                            <th>Product Name</th>
                            <th>Unit</th>
                            <th>Current Stock</th>
                            <th>Reorder Level</th>
                            <th>Avg Unit Cost</th>
                            <th>Total Cost</th>
                          </tr>
                        </thead>
                        <tbody>
                          {importData.slice(0, 5).map((item, i) => (
                            <tr key={i}>
                              <td>{item.productName}</td>
                              <td>{item.unit}</td>
                              <td>{item.currentStock}</td>
                              <td>{item.reorderLevel}</td>
                              <td>{helpers.formatCurrency(item.averageUnitCost)}</td>
                              <td>{helpers.formatCurrency(item.currentStock * item.averageUnitCost)}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}
                
                {importErrors.length > 0 && (
                  <div className="alert alert-warning" style={{ marginTop: '15px' }}>
                    <strong>Errors:</strong>
                    <ul style={{ marginLeft: '20px' }}>
                      {importErrors.slice(0, 5).map((e, i) => <li key={i}>{e}</li>)}
                    </ul>
                  </div>
                )}
              </div>
            )}
            
            <div style={{ display: 'flex', gap: '10px', justifyContent: 'center', marginTop: '25px' }}>
              {activeTab === 'manual' && (
                <button className="btn btn-add" onClick={handleManualSubmit}>
                  <span>ðŸ’¾</span> Save Products
                </button>
              )}
              {activeTab === 'import' && importData.length > 0 && (
                <button className="btn btn-import" onClick={handleImportSubmit}>
                  <span>ðŸ“¥</span> Import Products
                </button>
              )}
              <button className="btn" onClick={onClose} style={{ background: 'linear-gradient(135deg, #7f8c8d 0%, #34495e 100%)' }}>
                <span>â†©ï¸</span> Cancel
              </button>
            </div>
          </div>
        </div>
      );
    }
    
    // ================= MAIN APP COMPONENT =================
    function App() {
      const [isLoading, setIsLoading] = React.useState(true);
      const [user, setUser] = React.useState(null);
      const [loginData, setLoginData] = React.useState({ username: '', password: '' });
      const [activeView, setActiveView] = React.useState('dashboard');
      const [products, setProducts] = React.useState([]);
      const [movements, setMovements] = React.useState([]);
      const [users, setUsers] = React.useState([]);
      const [alert, setAlert] = React.useState({ show: false, message: '', type: '' });
      const [showDeleteModal, setShowDeleteModal] = React.useState(false);
      const [productToDelete, setProductToDelete] = React.useState(null);
      const [stats, setStats] = React.useState(null);
      const [showChangePasswordModal, setShowChangePasswordModal] = React.useState(false);
      const [changePasswordData, setChangePasswordData] = React.useState({
        currentPassword: '',
        newPassword: '',
        confirmPassword: ''
      });
      const [showImportModal, setShowImportModal] = React.useState(false);
      const [importData, setImportData] = React.useState([]);
      const [importErrors, setImportErrors] = React.useState([]);
      const [showBackupModal, setShowBackupModal] = React.useState(false);
      const [showAddProductsModal, setShowAddProductsModal] = React.useState(false);
      const [chartDetails, setChartDetails] = React.useState({ show: false, title: '', products: [] });
      const [lastSync, setLastSync] = React.useState(null);
      const [driveStatus, setDriveStatus] = React.useState({
        initialized: false,
        signedIn: false,
        loading: false
      });
      
      React.useEffect(() => {
        const initApp = async () => {
          try {
            console.log("Initializing app...");
            await initializeDatabase();
            
            const [productList, movementList, userList] = await Promise.all([
              db.products.toArray(),
              db.movements.toArray(),
              db.users.toArray()
            ]);
            
            setProducts(productList);
            setMovements(movementList);
            setUsers(userList);
            
            const calculatedStats = helpers.calculateStats(productList, movementList);
            setStats(calculatedStats);
            
            // Initialize Google Drive
            const driveInitialized = await GoogleDriveManager.init();
            setDriveStatus({
              initialized: driveInitialized,
              signedIn: GoogleDriveManager.isSignedIn,
              loading: false
            });
            
            setIsLoading(false);
            console.log("App initialized successfully");
          } catch (error) {
            console.error("App initialization error:", error);
            showAlert('Failed to initialize application', 'error');
            setIsLoading(false);
          }
        };
        
        initApp();
        
        // Listen for data change events (for sync)
        const handleDataChange = () => {
          loadData();
        };
        
        window.addEventListener('dataChanged', handleDataChange);
        
        return () => {
          window.removeEventListener('dataChanged', handleDataChange);
        };
      }, []);
      
      React.useEffect(() => {
        if (products.length > 0 && movements.length > 0) {
          const calculatedStats = helpers.calculateStats(products, movements);
          setStats(calculatedStats);
        }
      }, [products, movements]);
      
      // Auto-sync every 5 minutes if signed in
      React.useEffect(() => {
        if (GoogleDriveManager.isSignedIn) {
          const syncInterval = setInterval(async () => {
            try {
              const driveBackups = await GoogleDriveManager.listBackups();
              if (driveBackups.length > 0) {
                const latestBackup = driveBackups[0];
                const backupData = await GoogleDriveManager.restoreBackup(latestBackup.id);
                
                if (backupData && backupData.data) {
                  await GoogleDriveManager.syncData(backupData.data);
                  setLastSync(new Date());
                  console.log("Auto-sync completed at", new Date().toLocaleTimeString());
                }
              }
            } catch (error) {
              console.error("Auto-sync error:", error);
            }
          }, 5 * 60 * 1000); // 5 minutes
          
          return () => clearInterval(syncInterval);
        }
      }, [GoogleDriveManager.isSignedIn]);
      
      const showAlert = (message, type) => {
        setAlert({ show: true, message, type });
        setTimeout(() => setAlert({ show: false, message: '', type: '' }), 5000);
      };
      
      const loadData = async () => {
        try {
          const [productList, movementList, userList] = await Promise.all([
            db.products.toArray(),
            db.movements.toArray(),
            db.users.toArray()
          ]);
          
          setProducts(productList);
          setMovements(movementList);
          setUsers(userList);
        } catch (error) {
          console.error("Error loading data:", error);
          showAlert('Error loading data', 'error');
        }
      };
      
      const handleLogin = async (e) => {
        e.preventDefault();
        try {
          console.log("Login attempt for:", loginData.username);
          
          // Get all users
          const allUsers = await db.users.toArray();
          console.log("Available users:", allUsers.map(u => u.username));
          
          // Find user (case-insensitive)
          const foundUser = allUsers.find(u => 
            u.username.toLowerCase() === loginData.username.toLowerCase()
          );
          
          if (!foundUser) {
            showAlert('Invalid username or password', 'error');
            return;
          }
          
          if (foundUser.password !== loginData.password) {
            showAlert('Invalid username or password', 'error');
            return;
          }
          
          setUser(foundUser);
          
          // Check Google Drive connection
          if (driveStatus.initialized && GoogleDriveManager.isSignedIn) {
            showAlert(`Welcome back, ${foundUser.name}! Connected to Google Drive`, 'success');
          } else {
            showAlert(`Welcome back, ${foundUser.name}!`, 'success');
          }
          
          setActiveView('dashboard');
        } catch (error) {
          console.error("Login error:", error);
          showAlert('Login failed. Please try again.', 'error');
        }
      };
      
      const logout = () => {
        setUser(null);
        setLoginData({ username: '', password: '' });
        showAlert('Logged out successfully', 'success');
      };
      
      const addProduct = async (product) => {
        try {
          if (!product.name || !product.unit) {
            showAlert('Please fill all required fields', 'error');
            return;
          }
          
          const newProduct = {
            name: product.name.trim(),
            unit: product.unit.trim(),
            reorderLevel: parseInt(product.reorderLevel) || 0,
            currentUnitCost: parseFloat(product.currentUnitCost) || 0,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          };
          
          await db.products.add(newProduct);
          await loadData();
          showAlert('Product added successfully', 'success');
          
          // Trigger data change for sync
          window.dispatchEvent(new CustomEvent('dataChanged'));
        } catch (error) {
          console.error("Error adding product:", error);
          showAlert('Error adding product', 'error');
        }
      };
      
      const updateProduct = async (id, updates) => {
        try {
          const now = new Date().toISOString();
          await db.products.update(id, {
            ...updates,
            updatedAt: now
          });
          
          await loadData();
          showAlert('Product updated successfully', 'success');
          
          // Trigger data change for sync
          window.dispatchEvent(new CustomEvent('dataChanged'));
        } catch (error) {
          console.error("Error updating product:", error);
          showAlert('Error updating product', 'error');
        }
      };
      
      const deleteProduct = async (id) => {
        try {
          // Check if product has movements
          const productMovements = await db.movements.where("productId").equals(id).count();
          
          if (productMovements > 0) {
            showAlert('Cannot delete product with transaction history', 'error');
            return;
          }
          
          await db.products.delete(id);
          await loadData();
          showAlert('Product deleted successfully', 'success');
          
          // Trigger data change for sync
          window.dispatchEvent(new CustomEvent('dataChanged'));
        } catch (error) {
          console.error("Error deleting product:", error);
          showAlert('Error deleting product', 'error');
        }
      };
      
      const addMovement = async (movement) => {
        try {
          if (!movement.productId || movement.quantity <= 0) {
            showAlert('Please select product and enter valid quantity', 'error');
            return;
          }
          
          const product = products.find(p => p.id === movement.productId);
          const currentStock = helpers.getProductBalance(movement.productId, movements);
          
          if (movement.type === 'OUT' && movement.quantity > currentStock) {
            showAlert(`Insufficient stock! Available: ${currentStock} ${product.unit}`, 'error');
            return;
          }
          
          const unitCost = parseFloat(movement.unitCost) || product.currentUnitCost || 0;
          const totalValue = movement.quantity * unitCost;
          
          const newMovement = {
            ...movement,
            date: new Date().toISOString(),
            userId: user.id,
            unitCost,
            totalValue
          };
          
          await db.movements.add(newMovement);
          await loadData();
          showAlert('Transaction recorded successfully', 'success');
          
          // Trigger data change for sync
          window.dispatchEvent(new CustomEvent('dataChanged'));
        } catch (error) {
          console.error("Error recording transaction:", error);
          showAlert('Error recording transaction', 'error');
        }
      };
      
      // Fixed importStockData function â€“ now works!
      const importStockData = async (importBatch) => {
        try {
          if (!importBatch || importBatch.length === 0) {
            showAlert('No valid data to import', 'error');
            return;
          }
          
          let successCount = 0;
          let errorCount = 0;
          
          for (const item of importBatch) {
            try {
              // Check if product exists (should not, because we already filtered in modal, but double-check)
              let existing = products.find(p => p.name.toLowerCase() === item.productName.toLowerCase());
              if (existing) {
                errorCount++;
                continue;
              }
              
              // Create new product
              const productId = await db.products.add({
                name: item.productName,
                unit: item.unit,
                reorderLevel: item.reorderLevel,
                currentUnitCost: item.averageUnitCost,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
              });
              
              // Add initial stock movement
              if (item.currentStock > 0) {
                await db.movements.add({
                  productId: productId,
                  type: 'IN',
                  quantity: item.currentStock,
                  unitCost: item.averageUnitCost,
                  reference: 'STOCK_IMPORT',
                  date: new Date().toISOString(),
                  userId: user?.id || null,
                  totalValue: item.currentStock * item.averageUnitCost,
                  importBatch: `IMPORT_${Date.now()}`
                });
              }
              
              successCount++;
            } catch (err) {
              console.error('Error importing item:', err);
              errorCount++;
            }
          }
          
          await loadData();
          
          if (successCount > 0) {
            showAlert(`Successfully imported ${successCount} products${errorCount > 0 ? `, ${errorCount} failed` : ''}`, 'success');
            window.dispatchEvent(new CustomEvent('dataChanged'));
            setShowImportModal(false);
            setImportData([]);
            setImportErrors([]);
          } else {
            showAlert('No products were imported. Please check your data format.', 'error');
          }
        } catch (error) {
          console.error('Error importing stock data:', error);
          showAlert('Error importing data', 'error');
        }
      };
      
      const changePassword = async () => {
        try {
          // Validate current password
          if (changePasswordData.currentPassword !== user.password) {
            showAlert('Current password is incorrect', 'error');
            return;
          }
          
          // Validate new password
          const validation = helpers.validatePassword(changePasswordData.newPassword);
          if (!validation.valid) {
            showAlert(validation.message, 'error');
            return;
          }
          
          // Check if new password matches confirmation
          if (changePasswordData.newPassword !== changePasswordData.confirmPassword) {
            showAlert('New password and confirmation do not match', 'error');
            return;
          }
          
          // Update password
          await db.users.update(user.id, {
            password: changePasswordData.newPassword
          });
          
          // Update local user state
          setUser({
            ...user,
            password: changePasswordData.newPassword
          });
          
          // Clear form and close modal
          setChangePasswordData({
            currentPassword: '',
            newPassword: '',
            confirmPassword: ''
          });
          setShowChangePasswordModal(false);
          
          showAlert('Password changed successfully', 'success');
        } catch (error) {
          console.error("Error changing password:", error);
          showAlert('Error changing password', 'error');
        }
      };
      
      const exportToExcel = (reportType, filteredData = null, columns = []) => {
        try {
          let reportData = [];
          let fileName = '';
          
          if (reportType === 'stock') {
            const dataToExport = filteredData || products;
            reportData = dataToExport.map(product => {
              const stock = helpers.getProductBalance(product.id, movements);
              const status = helpers.getProductStatus(product.id, products, movements);
              const costData = helpers.calculateProductCost(product.id, movements);
              
              return {
                'Product ID': product.id,
                'Product Name': product.name,
                'Unit': product.unit,
                'Current Stock': stock,
                'Reorder Level': product.reorderLevel,
                'Total Cost of Purchases (GHÂ¢)': costData.totalCost,
                'Average Unit Cost (GHÂ¢)': costData.averageUnitCost.toFixed(2),
                'Current Inventory Value (GHÂ¢)': costData.currentValue.toFixed(2),
                'Status': status
              };
            });
            
            fileName = `Stock_Report_${new Date().toISOString().split('T')[0]}.xlsx`;
          } 
          else if (reportType === 'transactions') {
            const dataToExport = filteredData || movements;
            reportData = dataToExport.map(movement => {
              const product = products.find(p => p.id === movement.productId);
              const userObj = users.find(u => u.id === movement.userId);
              
              return {
                'Date': helpers.formatDateShort(movement.date),
                'Product': product ? product.name : `Product ${movement.productId}`,
                'Type': movement.type === 'IN' ? 'Receipt' : 'Issue',
                'Quantity': movement.quantity,
                'Unit Cost (GHÂ¢)': movement.unitCost || 0,
                'Total Value (GHÂ¢)': movement.totalValue || 0,
                'Reference': movement.reference || '-',
                'User': userObj ? userObj.name : `User ${movement.userId}`,
                'Import Batch': movement.importBatch || '-'
              };
            });
            
            fileName = `Transaction_Report_${new Date().toISOString().split('T')[0]}.xlsx`;
          }
          
          const worksheet = XLSX.utils.json_to_sheet(reportData);
          const workbook = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(workbook, worksheet, 'Report');
          XLSX.writeFile(workbook, fileName);
          
          showAlert('Report exported to Excel successfully', 'success');
        } catch (error) {
          console.error("Export error:", error);
          showAlert('Error exporting report', 'error');
        }
      };
      
      const exportToWord = (reportType, filteredData = null, title = 'Report') => {
        try {
          let reportData = [];
          let columns = [];
          
          if (reportType === 'stock') {
            const dataToExport = filteredData || products;
            columns = ['Product Name', 'Unit', 'Current Stock', 'Reorder Level', 'Total Cost of Purchases (GHÂ¢)', 'Average Unit Cost (GHÂ¢)', 'Current Inventory Value (GHÂ¢)', 'Status'];
            
            reportData = dataToExport.map(product => {
              const stock = helpers.getProductBalance(product.id, movements);
              const status = helpers.getProductStatus(product.id, products, movements);
              const costData = helpers.calculateProductCost(product.id, movements);
              
              return {
                'Product Name': product.name,
                'Unit': product.unit,
                'Current Stock': stock,
                'Reorder Level': product.reorderLevel,
                'Total Cost of Purchases (GHÂ¢)': helpers.formatCurrency(costData.totalCost),
                'Average Unit Cost (GHÂ¢)': helpers.formatCurrency(costData.averageUnitCost),
                'Current Inventory Value (GHÂ¢)': helpers.formatCurrency(costData.currentValue),
                'Status': status
              };
            });
          } 
          else if (reportType === 'transactions') {
            const dataToExport = filteredData || movements;
            columns = ['Date', 'Product', 'Type', 'Quantity', 'Unit Cost (GHÂ¢)', 'Total Value (GHÂ¢)', 'Reference', 'User'];
            
            reportData = dataToExport.map(movement => {
              const product = products.find(p => p.id === movement.productId);
              const userObj = users.find(u => u.id === movement.userId);
              
              return {
                'Date': helpers.formatDateShort(movement.date),
                'Product': product ? product.name : `Product ${movement.productId}`,
                'Type': movement.type === 'IN' ? 'Receipt' : 'Issue',
                'Quantity': movement.quantity,
                'Unit Cost (GHÂ¢)': helpers.formatCurrency(movement.unitCost || 0),
                'Total Value (GHÂ¢)': helpers.formatCurrency(movement.totalValue || 0),
                'Reference': movement.reference || '-',
                'User': userObj ? userObj.name : `User ${movement.userId}`
              };
            });
          }
          
          helpers.exportToWord(reportData, columns, title);
          showAlert('Report exported to Word successfully', 'success');
        } catch (error) {
          console.error("Word export error:", error);
          showAlert('Error exporting to Word', 'error');
        }
      };
      
      if (isLoading) {
        return <LoadingScreen />;
      }
      
      if (!user) {
        return (
          <div className="login-container">
            <div className="login-box">
              <h2><span className="gradient-text">ðŸ“¦</span> DUR Ahafo Stores Management System</h2>
              
              {alert.show && (
                <div className={`alert alert-${alert.type}`}>
                  <span>{alert.message}</span>
                  <button className="close-alert" onClick={() => setAlert({ show: false })}>
                    Ã—
                  </button>
                </div>
              )}
              
              <form onSubmit={handleLogin}>
                <div className="form-group">
                  <label>Username</label>
                  <select
                    className="form-control"
                    value={loginData.username}
                    onChange={(e) => setLoginData({...loginData, username: e.target.value})}
                    required
                  >
                    <option value="" disabled>Select username</option>
                    {users.map(user => (
                      <option key={user.id} value={user.username}>{user.username}</option>
                    ))}
                  </select>
                </div>
                
                <div className="form-group">
                  <label>Password</label>
                  <input
                    type="password"
                    className="form-control"
                    placeholder="Enter password"
                    value={loginData.password}
                    onChange={(e) => setLoginData({...loginData, password: e.target.value})}
                    required
                  />
                </div>
                
                <button type="submit" className="btn" style={{ width: '100%', marginTop: '10px' }}>
                  <span>ðŸ”‘</span> Login
                </button>
              </form>
              
              <div style={{ marginTop: '20px', textAlign: 'center' }}>
                <div className={`drive-status ${GoogleDriveManager.isSignedIn ? 'connected' : 'disconnected'}`}>
                  {GoogleDriveManager.isSignedIn ? 'âœ… Connected to Google Drive' : 'âš ï¸ Google Drive Not Connected'}
                </div>
              </div>
            </div>
          </div>
        );
      }
      
      return (
        <>
          <div className="app-container">
            <Sidebar 
              activeView={activeView}
              setActiveView={setActiveView}
              user={user}
              logout={logout}
              setShowChangePasswordModal={setShowChangePasswordModal}
              setShowBackupModal={setShowBackupModal}
            />
            
            <div className="main-content">
              {/* Top Bar */}
              <div className="top-bar">
                <div className="page-title">
                  {activeView === 'dashboard' && <><span>ðŸ“Š</span> Dashboard</>}
                  {activeView === 'products' && <><span>ðŸ“¦</span> Product Management</>}
                  {activeView === 'transactions' && <><span>ðŸ’°</span> Stock Transactions</>}
                  {activeView === 'history' && <><span>ðŸ“‹</span> Transaction History</>}
                  {activeView === 'reports' && <><span>ðŸ“ˆ</span> Reports</>}
                  {activeView === 'users' && <><span>ðŸ‘¥</span> User Management</>}
                </div>
                
                <div className="top-bar-actions">
                  {driveStatus.signedIn && (
                    <div className="drive-status connected" style={{ fontSize: '14px' }}>
                      <span>â˜ï¸</span> Drive Connected
                    </div>
                  )}
                </div>
              </div>
              
              {/* Alert */}
              {alert.show && (
                <div className={`alert alert-${alert.type}`}>
                  <span>{alert.message}</span>
                  <button className="close-alert" onClick={() => setAlert({ show: false })}>
                    Ã—
                  </button>
                </div>
              )}
              
              {/* Sync Status */}
              {lastSync && (
                <div className="storage-status">
                  <span>Last Sync: {lastSync.toLocaleTimeString()}</span>
                  <span style={{ color: '#27ae60', fontWeight: 'bold' }}>
                    âœ“ Multi-user sync enabled
                  </span>
                </div>
              )}
              
              {/* Main Content Area */}
              <div className="content-wrapper">
                {activeView === 'dashboard' && (
                  <>
                    <DashboardCharts 
                      products={products}
                      movements={movements}
                      helpers={helpers}
                      onSliceClick={(title, prods) => setChartDetails({ show: true, title, products: prods })}
                    />
                    <Dashboard 
                      products={products}
                      movements={movements}
                      stats={stats}
                      helpers={helpers}
                    />
                  </>
                )}
                
                {activeView === 'products' && (
                  <Products 
                    products={products}
                    movements={movements}
                    addProduct={addProduct}
                    updateProduct={updateProduct}
                    deleteProduct={deleteProduct}
                    confirmDelete={(product) => {
                      setProductToDelete(product);
                      setShowDeleteModal(true);
                    }}
                    user={user}
                    helpers={helpers}
                    showImportModal={() => setShowImportModal(true)}
                    showAddProductsModal={() => setShowAddProductsModal(true)}
                  />
                )}
                
                {activeView === 'transactions' && (user.role === 'STOREKEEPER' || user.role === 'ADMIN') && (
                  <Transactions 
                    products={products}
                    movements={movements}
                    addMovement={addMovement}
                    helpers={helpers}
                    user={user}
                  />
                )}
                
                {activeView === 'history' && (
                  <History 
                    products={products}
                    movements={movements}
                    users={users}
                    helpers={helpers}
                  />
                )}
                
                {activeView === 'reports' && (
                  <Reports 
                    products={products}
                    movements={movements}
                    users={users}
                    exportToExcel={exportToExcel}
                    exportToWord={exportToWord}
                    helpers={helpers}
                  />
                )}
                
                {activeView === 'users' && user.role === 'ADMIN' && (
                  <Users 
                    users={users}
                    helpers={helpers}
                    loadData={loadData}
                  />
                )}
              </div>
            </div>
          </div>
          
          {/* Delete Confirmation Modal */}
          {showDeleteModal && productToDelete && (
            <DeleteModal
              product={productToDelete}
              onConfirm={() => {
                deleteProduct(productToDelete.id);
                setShowDeleteModal(false);
                setProductToDelete(null);
              }}
              onCancel={() => {
                setShowDeleteModal(false);
                setProductToDelete(null);
              }}
            />
          )}
          
          {/* Change Password Modal */}
          {showChangePasswordModal && (
            <ChangePasswordModal
              onChange={changePassword}
              onCancel={() => {
                setShowChangePasswordModal(false);
                setChangePasswordData({
                  currentPassword: '',
                  newPassword: '',
                  confirmPassword: ''
                });
              }}
              data={changePasswordData}
              setData={setChangePasswordData}
              helpers={helpers}
            />
          )}
          
          {/* Import Modal (existing) â€“ now works! */}
          {showImportModal && (
            <StockImportModal
              onImport={importStockData}
              onCancel={() => {
                setShowImportModal(false);
                setImportData([]);
                setImportErrors([]);
              }}
              importData={importData}
              setImportData={setImportData}
              importErrors={importErrors}
              setImportErrors={setImportErrors}
              products={products}
              helpers={helpers}
            />
          )}
          
          {/* Add Products Records Modal (new) */}
          {showAddProductsModal && (
            <AddProductsRecordsModal
              onClose={() => setShowAddProductsModal(false)}
              onSave={() => {}}
              products={products}
              helpers={helpers}
              showAlert={showAlert}
            />
          )}
          
          {/* Backup Modal */}
          {showBackupModal && (
            <div className="modal-overlay">
              <div className="modal" style={{ maxWidth: '800px' }}>
                <BackupSync 
                  showAlert={showAlert}
                  onClose={() => setShowBackupModal(false)}
                />
              </div>
            </div>
          )}
          
          {/* Chart Details Modal */}
          {chartDetails.show && (
            <ChartDetailsModal
              title={chartDetails.title}
              products={chartDetails.products}
              onClose={() => setChartDetails({ show: false, title: '', products: [] })}
            />
          )}
        </>
      );
    }
    
    // ================= DASHBOARD COMPONENT =================
    function Dashboard({ products, movements, stats, helpers }) {
      const recentProducts = products.slice(-10).reverse();
      
      if (!stats) return <div className="card">Loading dashboard...</div>;
      
      return (
        <div>
          {/* Stats Cards */}
          <div className="stats-grid">
            <div className="stat-card">
              <div className="stat-icon">ðŸ“¦</div>
              <div className="stat-value">{stats.totalProducts}</div>
              <div className="stat-label">Total Products</div>
            </div>
            
            <div className="stat-card">
              <div className="stat-icon">âš ï¸</div>
              <div className="stat-value" style={{ 
                background: stats.lowStock > 0 ? 'linear-gradient(135deg, #f1c40f 0%, #f39c12 100%)' : 'linear-gradient(135deg, #2ecc71 0%, #27ae60 100%)',
                WebkitBackgroundClip: 'text',
                WebkitTextFillColor: 'transparent',
                backgroundClip: 'text'
              }}>
                {stats.lowStock}
              </div>
              <div className="stat-label">Low Stock Items</div>
            </div>
            
            <div className="stat-card">
              <div className="stat-icon">ðŸ›‘</div>
              <div className="stat-value" style={{ 
                background: stats.outOfStock > 0 ? 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)' : 'linear-gradient(135deg, #2ecc71 0%, #27ae60 100%)',
                WebkitBackgroundClip: 'text',
                WebkitTextFillColor: 'transparent',
                backgroundClip: 'text'
              }}>
                {stats.outOfStock}
              </div>
              <div className="stat-label">Out of Stock</div>
            </div>
            
            <div className="stat-card">
              <div className="stat-icon">ðŸ’°</div>
              <div className="stat-value">{helpers.formatCurrency(stats.totalInventoryValue)}</div>
              <div className="stat-label">Total Inventory Value</div>
            </div>
            
            <div className="stat-card">
              <div className="stat-icon">ðŸ“</div>
              <div className="stat-value">{stats.totalTransactions}</div>
              <div className="stat-label">Total Transactions</div>
            </div>
          </div>
          
          {/* Recent Products Overview */}
          <div className="card">
            <h3><span className="gradient-text">ðŸ“Š</span> Recent Products Overview</h3>
            <div className="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Product</th>
                    <th>Unit</th>
                    <th>Current Stock</th>
                    <th>Reorder Level</th>
                    <th>Total Cost of Purchases (GHÂ¢)</th>
                    <th>Average Unit Cost (GHÂ¢)</th>
                    <th>Current Inventory Value (GHÂ¢)</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {recentProducts.map(product => {
                    const stock = helpers.getProductBalance(product.id, movements);
                    const status = helpers.getProductStatus(product.id, products, movements);
                    const costData = helpers.calculateProductCost(product.id, movements);
                    
                    return (
                      <tr key={product.id}>
                        <td><strong>{product.name}</strong></td>
                        <td>{product.unit}</td>
                        <td style={{ 
                          fontWeight: 'bold',
                          color: status === 'OUT' ? '#e74c3c' : 
                                 status === 'LOW' ? '#f39c12' : '#27ae60'
                        }}>
                          {stock}
                        </td>
                        <td>{product.reorderLevel}</td>
                        <td>{helpers.formatCurrency(costData.totalCost)}</td>
                        <td>{helpers.formatCurrency(costData.averageUnitCost)}</td>
                        <td style={{ color: '#27ae60', fontWeight: 'bold' }}>
                          {helpers.formatCurrency(costData.currentValue)}
                        </td>
                        <td>
                          <span className={`status-badge status-${status.toLowerCase()}`}>
                            {status === 'OUT' ? 'ðŸ›‘ Out of Stock' : 
                             status === 'LOW' ? 'âš ï¸ Low Stock' : 'âœ“ In Stock'}
                          </span>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>
          
          {/* Low Stock Alerts */}
          {stats.lowStock > 0 && (
            <div className="card">
              <h3><span className="gradient-text">âš ï¸</span> Low Stock Alerts</h3>
              <div className="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>Product</th>
                      <th>Unit</th>
                      <th>Current Stock</th>
                      <th>Reorder Level</th>
                      <th>Total Cost of Purchases (GHÂ¢)</th>
                      <th>Average Unit Cost (GHÂ¢)</th>
                      <th>Current Inventory Value (GHÂ¢)</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {products
                      .filter(product => {
                        const status = helpers.getProductStatus(product.id, products, movements);
                        return status === 'LOW';
                      })
                      .map(product => {
                        const stock = helpers.getProductBalance(product.id, movements);
                        const status = helpers.getProductStatus(product.id, products, movements);
                        const costData = helpers.calculateProductCost(product.id, movements);
                        
                        return (
                          <tr key={product.id}>
                            <td><strong>{product.name}</strong></td>
                            <td>{product.unit}</td>
                            <td style={{ color: '#f39c12', fontWeight: 'bold' }}>{stock}</td>
                            <td>{product.reorderLevel}</td>
                            <td>{helpers.formatCurrency(costData.totalCost)}</td>
                            <td>{helpers.formatCurrency(costData.averageUnitCost)}</td>
                            <td>{helpers.formatCurrency(costData.currentValue)}</td>
                            <td>
                              <span className="status-badge status-low">
                                âš ï¸ Low Stock
                              </span>
                            </td>
                          </tr>
                        );
                      })}
                  </tbody>
                </table>
              </div>
            </div>
          )}
        </div>
      );
    }
    
    // ================= PRODUCTS COMPONENT =================
    function Products({ products, movements, addProduct, updateProduct, deleteProduct, confirmDelete, user, helpers, showImportModal, showAddProductsModal }) {
      const [newProduct, setNewProduct] = React.useState({
        name: '',
        unit: '',
        reorderLevel: '',
        currentUnitCost: ''
      });
      
      const [editingProduct, setEditingProduct] = React.useState(null);
      const [editForm, setEditForm] = React.useState({
        name: '',
        unit: '',
        reorderLevel: '',
        currentUnitCost: ''
      });
      
      const handleAddProduct = () => {
        addProduct(newProduct);
        setNewProduct({ name: '', unit: '', reorderLevel: '', currentUnitCost: '' });
      };
      
      const handleEditClick = (product) => {
        setEditingProduct(product.id);
        setEditForm({
          name: product.name,
          unit: product.unit,
          reorderLevel: product.reorderLevel,
          currentUnitCost: product.currentUnitCost || ''
        });
      };
      
      const handleUpdateProduct = () => {
        updateProduct(editingProduct, editForm);
        setEditingProduct(null);
      };
      
      const handleCancelEdit = () => {
        setEditingProduct(null);
      };
      
      return (
        <div className="card">
          <h3><span className="gradient-text">ðŸ“¦</span> Product Management ({products.length} products)</h3>
          
          {/* Add Product Form */}
          {(user.role === 'STOREKEEPER' || user.role === 'ADMIN') && (
            <div className="filter-section">
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                <h4 style={{ color: '#1a237e' }}>Add New Product</h4>
                <div style={{ display: 'flex', gap: '10px' }}>
                  <button className="btn btn-import" onClick={showImportModal}>
                    <span>ðŸ“¥</span> Import Stock Data
                  </button>
                  <button className="btn btn-add" onClick={showAddProductsModal}>
                    <span>âž•</span> Add Products Records
                  </button>
                </div>
              </div>
              <div className="form-row">
                <div className="form-group">
                  <input
                    type="text"
                    className="form-control"
                    placeholder="Product Name *"
                    value={newProduct.name}
                    onChange={(e) => setNewProduct({...newProduct, name: e.target.value})}
                    required
                  />
                </div>
                
                <div className="form-group">
                  <input
                    type="text"
                    className="form-control"
                    placeholder="Unit (e.g., Piece) *"
                    value={newProduct.unit}
                    onChange={(e) => setNewProduct({...newProduct, unit: e.target.value})}
                    required
                  />
                </div>
                
                <div className="form-group">
                  <input
                    type="number"
                    className="form-control"
                    placeholder="Reorder Level"
                    value={newProduct.reorderLevel}
                    onChange={(e) => setNewProduct({...newProduct, reorderLevel: e.target.value})}
                    min="0"
                  />
                </div>
                
                <div className="form-group">
                  <input
                    type="number"
                    step="0.01"
                    className="form-control"
                    placeholder="Unit Cost (GHÂ¢)"
                    value={newProduct.currentUnitCost}
                    onChange={(e) => setNewProduct({...newProduct, currentUnitCost: e.target.value})}
                    min="0"
                  />
                </div>
                
                <div className="form-group">
                  <button className="btn btn-add" onClick={handleAddProduct}>
                    <span>âž•</span> Add Product
                  </button>
                </div>
              </div>
            </div>
          )}
          
          {/* Products Table */}
          <div className="table-container">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Unit</th>
                  <th>Current Stock</th>
                  <th>Reorder Level</th>
                  <th>Total Cost of Purchases (GHÂ¢)</th>
                  <th>Average Unit Cost (GHÂ¢)</th>
                  <th>Current Value (GHÂ¢)</th>
                  <th>Status</th>
                  {(user.role === 'STOREKEEPER' || user.role === 'ADMIN') && <th>Actions</th>}
                </tr>
              </thead>
              <tbody>
                {products.map(product => {
                  const stock = helpers.getProductBalance(product.id, movements);
                  const status = helpers.getProductStatus(product.id, products, movements);
                  const costData = helpers.calculateProductCost(product.id, movements);
                  
                  if (editingProduct === product.id) {
                    return (
                      <tr key={product.id}>
                        <td>{product.id}</td>
                        <td>
                          <input
                            type="text"
                            className="form-control"
                            value={editForm.name}
                            onChange={(e) => setEditForm({...editForm, name: e.target.value})}
                            style={{ width: '100%' }}
                          />
                        </td>
                        <td>
                          <input
                            type="text"
                            className="form-control"
                            value={editForm.unit}
                            onChange={(e) => setEditForm({...editForm, unit: e.target.value})}
                            style={{ width: '100%' }}
                          />
                        </td>
                        <td>{stock}</td>
                        <td>
                          <input
                            type="number"
                            className="form-control"
                            value={editForm.reorderLevel}
                            onChange={(e) => setEditForm({...editForm, reorderLevel: e.target.value})}
                            style={{ width: '100%' }}
                          />
                        </td>
                        <td>{helpers.formatCurrency(costData.totalCost)}</td>
                        <td>{helpers.formatCurrency(costData.averageUnitCost)}</td>
                        <td>{helpers.formatCurrency(costData.currentValue)}</td>
                        <td>
                          <span className={`status-badge status-${status.toLowerCase()}`}>
                            {status === 'OUT' ? 'ðŸ›‘ Out' : 
                             status === 'LOW' ? 'âš ï¸ Low' : 'âœ“ OK'}
                          </span>
                        </td>
                        <td>
                          <div className="action-buttons">
                            <button onClick={handleUpdateProduct} className="btn btn-add" style={{ padding: '8px 16px' }}>
                              <span>ðŸ’¾</span> Save
                            </button>
                            <button onClick={handleCancelEdit} className="btn btn-delete" style={{ padding: '8px 16px' }}>
                              <span>â†©ï¸</span> Cancel
                            </button>
                          </div>
                        </td>
                      </tr>
                    );
                  }
                  
                  return (
                    <tr key={product.id}>
                      <td>{product.id}</td>
                      <td><strong>{product.name}</strong></td>
                      <td>{product.unit}</td>
                      <td style={{ 
                        fontWeight: 'bold',
                        color: stock === 0 ? '#e74c3c' : stock <= product.reorderLevel ? '#f39c12' : '#27ae60'
                      }}>
                        {stock}
                      </td>
                      <td>{product.reorderLevel}</td>
                      <td>{helpers.formatCurrency(costData.totalCost)}</td>
                      <td>{helpers.formatCurrency(costData.averageUnitCost)}</td>
                      <td style={{ color: '#27ae60', fontWeight: 'bold' }}>
                        {helpers.formatCurrency(costData.currentValue)}
                      </td>
                      <td>
                        <span className={`status-badge status-${status.toLowerCase()}`}>
                          {status === 'OUT' ? 'ðŸ›‘ Out of Stock' : 
                           status === 'LOW' ? 'âš ï¸ Low Stock' : 'âœ“ In Stock'}
                        </span>
                      </td>
                      {(user.role === 'STOREKEEPER' || user.role === 'ADMIN') && (
                        <td>
                          <div className="action-buttons">
                            <button 
                              onClick={() => handleEditClick(product)} 
                              className="btn btn-edit"
                            >
                              <span>âœï¸</span> Edit
                            </button>
                            <button 
                              onClick={() => confirmDelete(product)} 
                              className="btn btn-delete"
                            >
                              <span>ðŸ—‘ï¸</span> Delete
                            </button>
                          </div>
                        </td>
                      )}
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      );
    }
    
    // ================= STOCK IMPORT MODAL =================
    function StockImportModal({ onImport, onCancel, importData, setImportData, importErrors, setImportErrors, products, helpers }) {
      const fileInputRef = React.useRef(null);
      
      const handleFileSelect = (event) => {
        const file = event.target.files[0];
        if (file) {
          readExcelFile(file);
        }
      };
      
      const readExcelFile = (file) => {
        const reader = new FileReader();
        
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet);
            
            const processedData = [];
            const errors = [];
            
            jsonData.forEach((row, index) => {
              const rowNumber = index + 2;
              
              if (!row['Product Name']) {
                errors.push(`Row ${rowNumber}: Missing product name`);
                return;
              }
              
              const productName = row['Product Name'].toString().trim();
              const unit = row['Unit'] || 'Piece';
              const currentStock = parseInt(row['Current Stock'] || 0);
              const reorderLevel = parseInt(row['Reorder Level'] || 0);
              const averageUnitCost = parseFloat(row['Average Unit Cost (GHÂ¢)'] || row['Average Unit Cost'] || 0);
              
              if (isNaN(currentStock) || currentStock < 0) {
                errors.push(`Row ${rowNumber}: Invalid current stock`);
                return;
              }
              
              if (isNaN(reorderLevel) || reorderLevel < 0) {
                errors.push(`Row ${rowNumber}: Invalid reorder level`);
                return;
              }
              
              if (isNaN(averageUnitCost) || averageUnitCost < 0) {
                errors.push(`Row ${rowNumber}: Invalid average unit cost`);
                return;
              }
              
              // Check if product already exists
              const existingProduct = products.find(p => 
                p.name.toLowerCase() === productName.toLowerCase()
              );
              
              if (existingProduct) {
                errors.push(`Row ${rowNumber}: Product "${productName}" already exists`);
                return;
              }
              
              processedData.push({
                productName,
                unit,
                currentStock,
                reorderLevel,
                averageUnitCost,
                totalCost: (currentStock * averageUnitCost).toFixed(2),
                currentValue: (currentStock * averageUnitCost).toFixed(2)
              });
            });
            
            setImportData(processedData);
            setImportErrors(errors);
            
            if (processedData.length === 0 && errors.length > 0) {
              alert('No valid data found in file. Please check the template format.');
            }
            
          } catch (error) {
            console.error("Error reading Excel file:", error);
            alert('Error reading file. Please make sure it is a valid Excel file.');
          }
        };
        
        reader.readAsArrayBuffer(file);
      };
      
      return (
        <div className="modal-overlay">
          <div className="modal" style={{ maxWidth: '900px' }}>
            <h3><span className="gradient-text">ðŸ“¥</span> Import Stock Data</h3>
            
            <div className="import-section">
              <div style={{ textAlign: 'center', padding: '40px' }}>
                <button 
                  className="btn btn-import"
                  onClick={() => fileInputRef.current.click()}
                  style={{ padding: '20px 40px', fontSize: '18px' }}
                >
                  <span>ðŸ“„</span> Select Excel File
                </button>
                <input
                  type="file"
                  ref={fileInputRef}
                  style={{ display: 'none' }}
                  accept=".xlsx,.xls"
                  onChange={handleFileSelect}
                />
                
                <p style={{ marginTop: '20px', color: '#666', fontSize: '14px' }}>
                  Upload an Excel file with the following columns:<br/>
                  <strong>Product Name, Unit, Current Stock, Reorder Level, Average Unit Cost (GHÂ¢)</strong>
                </p>
              </div>
              
              <div style={{ textAlign: 'center', marginTop: '20px' }}>
                <button 
                  className="btn btn-download-template" 
                  onClick={helpers.generateImportTemplate}
                >
                  <span>ðŸ“‹</span> Download Template
                </button>
              </div>
            </div>
            
            {importData.length > 0 && (
              <div className="import-preview">
                <h4 style={{ color: '#1a237e', marginBottom: '15px' }}>Preview ({importData.length} products)</h4>
                <div className="table-container">
                  <table>
                    <thead>
                      <tr>
                        <th>Product Name</th>
                        <th>Unit</th>
                        <th>Current Stock</th>
                        <th>Reorder Level</th>
                        <th>Average Unit Cost (GHÂ¢)</th>
                        <th>Current Value (GHÂ¢)</th>
                      </tr>
                    </thead>
                    <tbody>
                      {importData.slice(0, 10).map((item, index) => (
                        <tr key={index}>
                          <td>{item.productName}</td>
                          <td>{item.unit}</td>
                          <td>{item.currentStock}</td>
                          <td>{item.reorderLevel}</td>
                          <td>{helpers.formatCurrency(item.averageUnitCost)}</td>
                          <td>{helpers.formatCurrency(item.currentStock * item.averageUnitCost)}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}
            
            {importErrors.length > 0 && (
              <div className="alert alert-warning">
                <div>
                  <strong>Found {importErrors.length} error(s):</strong>
                  <ul style={{ marginTop: '5px', marginLeft: '20px', fontSize: '13px' }}>
                    {importErrors.slice(0, 5).map((error, index) => (
                      <li key={index}>{error}</li>
                    ))}
                  </ul>
                </div>
              </div>
            )}
            
            <div style={{ display: 'flex', gap: '10px', marginTop: '25px', justifyContent: 'center' }}>
              <button 
                onClick={() => onImport(importData)} 
                className="btn btn-import"
                disabled={importData.length === 0}
                style={{ padding: '15px 30px', fontSize: '16px' }}
              >
                <span>ðŸ“¥</span> Import Stock Data
              </button>
              <button onClick={onCancel} className="btn" style={{ 
                background: 'linear-gradient(135deg, #7f8c8d 0%, #34495e 100%)',
                padding: '15px 30px',
                fontSize: '16px'
              }}>
                <span>â†©ï¸</span> Cancel
              </button>
            </div>
          </div>
        </div>
      );
    }
    
    // ================= REPORTS COMPONENT =================
    function Reports({ products, movements, users, exportToExcel, exportToWord, helpers }) {
      const [reportType, setReportType] = React.useState('stock');
      const [stockFilters, setStockFilters] = React.useState({
        statuses: ['IN_STOCK', 'LOW_STOCK', 'OUT_OF_STOCK'],
        startDate: '',
        endDate: ''
      });
      
      const [transactionFilters, setTransactionFilters] = React.useState({
        types: ['IN', 'OUT'],
        startDate: '',
        endDate: ''
      });
      
      const toggleStockStatus = (status) => {
        setStockFilters(prev => {
          const newStatuses = prev.statuses.includes(status)
            ? prev.statuses.filter(s => s !== status)
            : [...prev.statuses, status];
          return { ...prev, statuses: newStatuses };
        });
      };
      
      const toggleTransactionType = (type) => {
        setTransactionFilters(prev => {
          const newTypes = prev.types.includes(type)
            ? prev.types.filter(t => t !== type)
            : [...prev.types, type];
          return { ...prev, types: newTypes };
        });
      };
      
      const getFilteredStockData = () => {
        return products.filter(product => {
          const status = helpers.getProductStatus(product.id, products, movements);
          const statusMap = {
            'OK': 'IN_STOCK',
            'LOW': 'LOW_STOCK',
            'OUT': 'OUT_OF_STOCK'
          };
          
          return stockFilters.statuses.includes(statusMap[status]);
        });
      };
      
      const getFilteredTransactionData = () => {
        return movements.filter(movement => {
          // Filter by type
          if (!transactionFilters.types.includes(movement.type)) {
            return false;
          }
          
          // Filter by date range
          const movementDate = new Date(movement.date);
          if (transactionFilters.startDate) {
            const startDate = new Date(transactionFilters.startDate);
            if (movementDate < startDate) return false;
          }
          
          if (transactionFilters.endDate) {
            const endDate = new Date(transactionFilters.endDate);
            endDate.setHours(23, 59, 59, 999);
            if (movementDate > endDate) return false;
          }
          
          return true;
        });
      };
      
      const renderReportContent = () => {
        const filteredStockData = getFilteredStockData();
        const filteredTransactionData = getFilteredTransactionData();
        
        switch(reportType) {
          case 'stock':
            return (
              <>
                <div className="filter-section">
                  <h4 style={{ color: '#1a237e', marginBottom: '20px' }}>Stock Report Filters</h4>
                  
                  <div className="multi-select-container">
                    <div 
                      className={`multi-select-option ${stockFilters.statuses.includes('IN_STOCK') ? 'selected' : ''}`}
                      onClick={() => toggleStockStatus('IN_STOCK')}
                    >
                      <span className="checkmark">âœ“</span>
                      <span>âœ“</span> In Stock
                    </div>
                    <div 
                      className={`multi-select-option ${stockFilters.statuses.includes('LOW_STOCK') ? 'selected' : ''}`}
                      onClick={() => toggleStockStatus('LOW_STOCK')}
                    >
                      <span className="checkmark">âœ“</span>
                      <span>âš ï¸</span> Low Stock
                    </div>
                    <div 
                      className={`multi-select-option ${stockFilters.statuses.includes('OUT_OF_STOCK') ? 'selected' : ''}`}
                      onClick={() => toggleStockStatus('OUT_OF_STOCK')}
                    >
                      <span className="checkmark">âœ“</span>
                      <span>ðŸ›‘</span> Out of Stock
                    </div>
                  </div>
                  
                  <div className="date-range-filter">
                    <div className="date-input-group">
                      <label>Start Date</label>
                      <input
                        type="date"
                        className="form-control"
                        value={stockFilters.startDate}
                        onChange={e => setStockFilters({...stockFilters, startDate: e.target.value})}
                      />
                    </div>
                    <div className="date-input-group">
                      <label>End Date</label>
                      <input
                        type="date"
                        className="form-control"
                        value={stockFilters.endDate}
                        onChange={e => setStockFilters({...stockFilters, endDate: e.target.value})}
                      />
                    </div>
                  </div>
                </div>
                
                <div className="report-controls">
                  <button 
                    className="btn btn-export"
                    onClick={() => exportToExcel('stock', filteredStockData)}
                  >
                    <span>ðŸ“Š</span> Export to Excel
                  </button>
                  <button 
                    className="btn btn-print"
                    onClick={() => exportToWord('stock', filteredStockData, 'Stock Report')}
                  >
                    <span>ðŸ“</span> Export to Word
                  </button>
                </div>
                
                <div className="table-container">
                  <table>
                    <thead>
                      <tr>
                        <th>Product</th>
                        <th>Unit</th>
                        <th>Current Stock</th>
                        <th>Reorder Level</th>
                        <th>Total Cost of Purchases (GHÂ¢)</th>
                        <th>Average Unit Cost (GHÂ¢)</th>
                        <th>Current Inventory Value (GHÂ¢)</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      {filteredStockData.map(product => {
                        const stock = helpers.getProductBalance(product.id, movements);
                        const status = helpers.getProductStatus(product.id, products, movements);
                        const costData = helpers.calculateProductCost(product.id, movements);
                        
                        return (
                          <tr key={product.id}>
                            <td><strong>{product.name}</strong></td>
                            <td>{product.unit}</td>
                            <td style={{ fontWeight: 'bold' }}>{stock}</td>
                            <td>{product.reorderLevel}</td>
                            <td>{helpers.formatCurrency(costData.totalCost)}</td>
                            <td>{helpers.formatCurrency(costData.averageUnitCost)}</td>
                            <td style={{ color: '#27ae60', fontWeight: 'bold' }}>
                              {helpers.formatCurrency(costData.currentValue)}
                            </td>
                            <td>
                              <span className={`status-badge status-${status.toLowerCase()}`}>
                                {status === 'OUT' ? 'ðŸ›‘ Out of Stock' : 
                                 status === 'LOW' ? 'âš ï¸ Low Stock' : 'âœ“ In Stock'}
                              </span>
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              </>
            );
            
          case 'transactions':
            return (
              <>
                <div className="filter-section">
                  <h4 style={{ color: '#1a237e', marginBottom: '20px' }}>Transaction Report Filters</h4>
                  
                  <div className="multi-select-container">
                    <div 
                      className={`multi-select-option ${transactionFilters.types.includes('IN') ? 'selected' : ''}`}
                      onClick={() => toggleTransactionType('IN')}
                    >
                      <span className="checkmark">âœ“</span>
                      <span>ðŸ“¥</span> Receipts
                    </div>
                    <div 
                      className={`multi-select-option ${transactionFilters.types.includes('OUT') ? 'selected' : ''}`}
                      onClick={() => toggleTransactionType('OUT')}
                    >
                      <span className="checkmark">âœ“</span>
                      <span>ðŸ“¤</span> Issues
                    </div>
                  </div>
                  
                  <div className="date-range-filter">
                    <div className="date-input-group">
                      <label>Start Date</label>
                      <input
                        type="date"
                        className="form-control"
                        value={transactionFilters.startDate}
                        onChange={e => setTransactionFilters({...transactionFilters, startDate: e.target.value})}
                      />
                    </div>
                    <div className="date-input-group">
                      <label>End Date</label>
                      <input
                        type="date"
                        className="form-control"
                        value={transactionFilters.endDate}
                        onChange={e => setTransactionFilters({...transactionFilters, endDate: e.target.value})}
                      />
                    </div>
                  </div>
                </div>
                
                <div className="report-controls">
                  <button 
                    className="btn btn-export"
                    onClick={() => exportToExcel('transactions', filteredTransactionData)}
                  >
                    <span>ðŸ“Š</span> Export to Excel
                  </button>
                  <button 
                    className="btn btn-print"
                    onClick={() => exportToWord('transactions', filteredTransactionData, 'Transaction Report')}
                  >
                    <span>ðŸ“</span> Export to Word
                  </button>
                </div>
                
                <div className="table-container">
                  <table>
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Product</th>
                        <th>Type</th>
                        <th>Quantity</th>
                        <th>Unit Cost (GHÂ¢)</th>
                        <th>Total Value (GHÂ¢)</th>
                        <th>Reference</th>
                        <th>User</th>
                      </tr>
                    </thead>
                    <tbody>
                      {filteredTransactionData.map(movement => {
                        const product = products.find(p => p.id === movement.productId);
                        const userObj = users.find(u => u.id === movement.userId);
                        
                        return (
                          <tr key={movement.id}>
                            <td>{helpers.formatDateShort(movement.date)}</td>
                            <td>{product ? product.name : `Product ${movement.productId}`}</td>
                            <td>
                              <span style={{
                                color: movement.type === 'IN' ? '#27ae60' : '#e74c3c',
                                fontWeight: 'bold'
                              }}>
                                {movement.type === 'IN' ? 'Receipt' : 'Issue'}
                              </span>
                            </td>
                            <td>{movement.quantity}</td>
                            <td>{helpers.formatCurrency(movement.unitCost || 0)}</td>
                            <td style={{ fontWeight: 'bold', color: '#27ae60' }}>
                              {helpers.formatCurrency(movement.totalValue || 0)}
                            </td>
                            <td>{movement.reference || '-'}</td>
                            <td>{userObj ? userObj.name : `User ${movement.userId}`}</td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              </>
            );
            
          default:
            return <div>Select a report type</div>;
        }
      };
      
      return (
        <div className="card">
          <h3><span className="gradient-text">ðŸ“ˆ</span> Reports</h3>
          
          <div className="report-type-selector">
            <button 
              className={`report-type-btn ${reportType === 'stock' ? 'active' : ''}`}
              onClick={() => setReportType('stock')}
            >
              <span>ðŸ“Š</span> Stock Report
            </button>
            <button 
              className={`report-type-btn ${reportType === 'transactions' ? 'active' : ''}`}
              onClick={() => setReportType('transactions')}
            >
              <span>ðŸ“‹</span> Transaction Report
            </button>
          </div>
          
          {renderReportContent()}
        </div>
      );
    }
    
    // ================= TRANSACTIONS COMPONENT =================
    function Transactions({ products, movements, addMovement, helpers, user }) {
      const [transaction, setTransaction] = React.useState({
        productId: '',
        type: 'IN',
        quantity: '',
        reference: '',
        unitCost: ''
      });
      
      const selectedProduct = products.find(p => p.id === parseInt(transaction.productId));
      const currentStock = selectedProduct ? helpers.getProductBalance(selectedProduct.id, movements) : 0;
      
      const handleSubmit = () => {
        if (!transaction.productId || !transaction.quantity || parseInt(transaction.quantity) <= 0) {
          alert('Please select product and enter valid quantity');
          return;
        }
        
        const movement = {
          productId: parseInt(transaction.productId),
          type: transaction.type,
          quantity: parseInt(transaction.quantity),
          reference: transaction.reference,
          unitCost: parseFloat(transaction.unitCost) || undefined
        };
        
        addMovement(movement);
        setTransaction({ productId: '', type: 'IN', quantity: '', reference: '', unitCost: '' });
      };
      
      return (
        <div className="card">
          <h3><span className="gradient-text">ðŸ’°</span> Stock Transactions</h3>
          
          <div className="filter-section">
            <h4 style={{ color: '#1a237e', marginBottom: '20px' }}>New Transaction</h4>
            <div className="form-row">
              <div className="form-group">
                <select
                  className="form-control"
                  value={transaction.productId}
                  onChange={e => setTransaction({...transaction, productId: e.target.value})}
                  required
                >
                  <option value="">Select Product *</option>
                  {products.map(product => (
                    <option key={product.id} value={product.id}>
                      {product.name} (Stock: {helpers.getProductBalance(product.id, movements)} {product.unit})
                    </option>
                  ))}
                </select>
              </div>
              
              <div className="form-group">
                <select
                  className="form-control"
                  value={transaction.type}
                  onChange={e => setTransaction({...transaction, type: e.target.value})}
                >
                  <option value="IN">ðŸ“¥ Receive Stock</option>
                  <option value="OUT">ðŸ“¤ Issue Stock</option>
                </select>
              </div>
              
              <div className="form-group">
                <input
                  type="number"
                  className="form-control"
                  placeholder="Quantity *"
                  value={transaction.quantity}
                  onChange={e => setTransaction({...transaction, quantity: e.target.value})}
                  min="1"
                  required
                />
              </div>
              
              <div className="form-group">
                <input
                  type="number"
                  step="0.01"
                  className="form-control"
                  placeholder="Unit Cost (GHÂ¢) - Optional"
                  value={transaction.unitCost}
                  onChange={e => setTransaction({...transaction, unitCost: e.target.value})}
                  min="0"
                />
              </div>
              
              <div className="form-group">
                <input
                  type="text"
                  className="form-control"
                  placeholder="Reference Number"
                  value={transaction.reference}
                  onChange={e => setTransaction({...transaction, reference: e.target.value})}
                />
              </div>
            </div>
            
            {selectedProduct && (
              <div className="info-box">
                <p><strong>Product:</strong> {selectedProduct.name}</p>
                <p><strong>Current Stock:</strong> {currentStock} {selectedProduct.unit}</p>
                <p><strong>Default Unit Cost:</strong> {helpers.formatCurrency(selectedProduct.currentUnitCost || 0)}</p>
                <p><strong>Transaction Type:</strong> 
                  <span style={{
                    color: transaction.type === 'IN' ? '#27ae60' : '#e74c3c',
                    marginLeft: '10px',
                    fontWeight: 'bold'
                  }}>
                    {transaction.type === 'IN' ? 'ðŸ“¥ Stock Receipt' : 'ðŸ“¤ Stock Issue'}
                  </span>
                </p>
                {transaction.quantity && (
                  <>
                    <p><strong>After Transaction:</strong> 
                      <span style={{
                        color: transaction.type === 'IN' ? '#27ae60' : '#e74c3c',
                        marginLeft: '10px',
                        fontWeight: 'bold'
                      }}>
                        {transaction.type === 'IN' 
                          ? currentStock + parseInt(transaction.quantity || 0)
                          : currentStock - parseInt(transaction.quantity || 0)} {selectedProduct.unit}
                      </span>
                    </p>
                    <p><strong>Total Transaction Value (GHÂ¢):</strong> 
                      <span style={{
                        color: '#27ae60',
                        marginLeft: '10px',
                        fontWeight: 'bold'
                      }}>
                        {helpers.formatCurrency(
                          (parseFloat(transaction.quantity) || 0) * 
                          (parseFloat(transaction.unitCost) || selectedProduct.currentUnitCost || 0)
                        )}
                      </span>
                    </p>
                  </>
                )}
              </div>
            )}
            
            <button 
              className="btn btn-transaction" 
              onClick={handleSubmit}
              style={{ marginTop: '20px' }}
            >
              <span>ðŸ’¾</span> Record Transaction
            </button>
          </div>
        </div>
      );
    }
    
    // ================= HISTORY COMPONENT =================
    function History({ products, movements, users, helpers }) {
      const [filters, setFilters] = React.useState({
        type: '',
        productId: '',
        startDate: '',
        endDate: ''
      });
      
      const filteredMovements = movements.filter(movement => {
        if (filters.type && movement.type !== filters.type) return false;
        if (filters.productId && movement.productId !== parseInt(filters.productId)) return false;
        
        const movementDate = new Date(movement.date);
        
        if (filters.startDate) {
          const startDate = new Date(filters.startDate);
          startDate.setHours(0, 0, 0, 0);
          if (movementDate < startDate) return false;
        }
        
        if (filters.endDate) {
          const endDate = new Date(filters.endDate);
          endDate.setHours(23, 59, 59, 999);
          if (movementDate > endDate) return false;
        }
        
        return true;
      }).reverse();
      
      return (
        <div className="card">
          <h3><span className="gradient-text">ðŸ“‹</span> Transaction History ({filteredMovements.length} records)</h3>
          
          <div className="filter-section">
            <h4 style={{ color: '#1a237e', marginBottom: '20px' }}>Filter History</h4>
            <div className="form-row">
              <div className="form-group">
                <select
                  className="form-control"
                  value={filters.type}
                  onChange={e => setFilters({...filters, type: e.target.value})}
                >
                  <option value="">All Types</option>
                  <option value="IN">Receipts Only</option>
                  <option value="OUT">Issues Only</option>
                </select>
              </div>
              
              <div className="form-group">
                <select
                  className="form-control"
                  value={filters.productId}
                  onChange={e => setFilters({...filters, productId: e.target.value})}
                >
                  <option value="">All Products</option>
                  {products.map(product => (
                    <option key={product.id} value={product.id}>{product.name}</option>
                  ))}
                </select>
              </div>
              
              <div className="form-group">
                <input
                  type="date"
                  className="form-control"
                  placeholder="Start Date"
                  value={filters.startDate}
                  onChange={e => setFilters({...filters, startDate: e.target.value})}
                />
              </div>
              
              <div className="form-group">
                <input
                  type="date"
                  className="form-control"
                  placeholder="End Date"
                  value={filters.endDate}
                  onChange={e => setFilters({...filters, endDate: e.target.value})}
                />
              </div>
              
              <div className="form-group">
                <button 
                  className="btn"
                  onClick={() => setFilters({ 
                    type: '', 
                    productId: '', 
                    startDate: '', 
                    endDate: ''
                  })}
                >
                  Clear Filters
                </button>
              </div>
            </div>
          </div>
          
          <div className="table-container">
            <table>
              <thead>
                <tr>
                  <th>Date & Time</th>
                  <th>Product</th>
                  <th>Type</th>
                  <th>Quantity</th>
                  <th>Unit Cost (GHÂ¢)</th>
                  <th>Total Value (GHÂ¢)</th>
                  <th>Reference</th>
                  <th>User</th>
                  <th>Import Batch</th>
                </tr>
              </thead>
              <tbody>
                {filteredMovements.map(movement => {
                  const product = products.find(p => p.id === movement.productId);
                  const user = users.find(u => u.id === movement.userId);
                  
                  return (
                    <tr key={movement.id}>
                      <td>{helpers.formatDate(movement.date)}</td>
                      <td>{product ? product.name : `Product ${movement.productId}`}</td>
                      <td>
                        <span style={{
                          color: movement.type === 'IN' ? '#27ae60' : '#e74c3c',
                          fontWeight: 'bold',
                          display: 'inline-flex',
                          alignItems: 'center',
                          gap: '5px'
                        }}>
                          {movement.type === 'IN' ? 'ðŸ“¥ IN' : 'ðŸ“¤ OUT'}
                        </span>
                      </td>
                      <td>{movement.quantity}</td>
                      <td>{helpers.formatCurrency(movement.unitCost || 0)}</td>
                      <td style={{ fontWeight: 'bold', color: '#27ae60' }}>
                        {helpers.formatCurrency(movement.totalValue || 0)}
                      </td>
                      <td>{movement.reference || '-'}</td>
                      <td>{user ? user.name : `User ${movement.userId}`}</td>
                      <td>{movement.importBatch || '-'}</td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
            
            {filteredMovements.length === 0 && (
              <div style={{ textAlign: 'center', padding: '40px', color: '#666' }}>
                No transactions found matching the filters.
              </div>
            )}
          </div>
        </div>
      );
    }
    
    // ================= USERS COMPONENT =================
    function Users({ users, helpers, loadData }) {
      const [showAddUserModal, setShowAddUserModal] = React.useState(false);
      const [newUser, setNewUser] = React.useState({
        username: '',
        name: '',
        password: '',
        role: 'STOREKEEPER'
      });
      
      const handleAddUser = async () => {
        try {
          if (!newUser.username || !newUser.name || !newUser.password) {
            alert('Please fill all required fields');
            return;
          }
          
          const validation = helpers.validatePassword(newUser.password);
          if (!validation.valid) {
            alert(validation.message);
            return;
          }
          
          // Check if username exists
          const existing = await db.users.where("username").equals(newUser.username).first();
          if (existing) {
            alert('Username already exists');
            return;
          }
          
          await db.users.add({
            username: newUser.username.trim(),
            name: newUser.name.trim(),
            password: newUser.password,
            role: newUser.role
          });
          
          await loadData();
          setShowAddUserModal(false);
          setNewUser({ username: '', name: '', password: '', role: 'STOREKEEPER' });
          alert('User added successfully');
        } catch (error) {
          console.error("Error adding user:", error);
          alert('Error adding user');
        }
      };
      
      return (
        <div className="card">
          <h3><span className="gradient-text">ðŸ‘¥</span> User Management</h3>
          
          <div style={{ marginBottom: '25px' }}>
            <button className="btn btn-add" onClick={() => setShowAddUserModal(true)}>
              <span>ðŸ‘¤</span> Add New User
            </button>
          </div>
          
          <div className="table-container">
            <table>
              <thead>
                <tr>
                  <th>Username</th>
                  <th>Name</th>
                  <th>Role</th>
                </tr>
              </thead>
              <tbody>
                {users.map(user => (
                  <tr key={user.id}>
                    <td><strong>{user.username}</strong></td>
                    <td>{user.name}</td>
                    <td>
                      <span style={{
                        background: user.role === 'ADMIN' ? 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)' : 
                                   user.role === 'STOREKEEPER' ? 'linear-gradient(135deg, #2ecc71 0%, #27ae60 100%)' : 
                                   'linear-gradient(135deg, #3498db 0%, #2980b9 100%)',
                        color: 'white',
                        padding: '6px 16px',
                        borderRadius: '20px',
                        fontSize: '13px',
                        fontWeight: '600',
                        boxShadow: '0 4px 8px rgba(0,0,0,0.1)'
                      }}>
                        {user.role}
                      </span>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          
          {/* Add User Modal */}
          {showAddUserModal && (
            <div className="modal-overlay">
              <div className="modal">
                <h3><span className="gradient-text">ðŸ‘¤</span> Add New User</h3>
                
                <div className="form-group">
                  <label>Username *</label>
                  <input
                    type="text"
                    className="form-control"
                    placeholder="Enter username"
                    value={newUser.username}
                    onChange={(e) => setNewUser({...newUser, username: e.target.value})}
                    required
                  />
                </div>
                
                <div className="form-group">
                  <label>Full Name *</label>
                  <input
                    type="text"
                    className="form-control"
                    placeholder="Enter full name"
                    value={newUser.name}
                    onChange={(e) => setNewUser({...newUser, name: e.target.value})}
                    required
                  />
                </div>
                
                <div className="form-group">
                  <label>Password *</label>
                  <input
                    type="password"
                    className="form-control"
                    placeholder="Enter password"
                    value={newUser.password}
                    onChange={(e) => setNewUser({...newUser, password: e.target.value})}
                    required
                  />
                </div>
                
                <div className="form-group">
                  <label>Role *</label>
                  <select
                    className="form-control"
                    value={newUser.role}
                    onChange={(e) => setNewUser({...newUser, role: e.target.value})}
                  >
                    <option value="STOREKEEPER">Storekeeper</option>
                    <option value="SUPERVISOR">Supervisor</option>
                    <option value="ADMIN">Admin</option>
                  </select>
                </div>
                
                <div style={{ display: 'flex', gap: '10px', marginTop: '25px' }}>
                  <button onClick={handleAddUser} className="btn btn-add">
                    <span>âž•</span> Add User
                  </button>
                  <button onClick={() => setShowAddUserModal(false)} className="btn" style={{ background: 'linear-gradient(135deg, #7f8c8d 0%, #34495e 100%)' }}>
                    <span>â†©ï¸</span> Cancel
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }
    
    // ================= DELETE MODAL =================
    function DeleteModal({ product, onConfirm, onCancel }) {
      return (
        <div className="modal-overlay">
          <div className="modal">
            <h3><span className="gradient-text">âš ï¸</span> Confirm Delete</h3>
            <p>Are you sure you want to delete <strong style={{ color: '#e74c3c' }}>{product.name}</strong>?</p>
            <p style={{ color: '#e74c3c', marginTop: '15px', fontSize: '14px', fontWeight: '600' }}>
              âš ï¸ Note: You cannot delete products that have transaction history.
            </p>
            <div style={{ display: 'flex', gap: '10px', marginTop: '25px' }}>
              <button onClick={onConfirm} className="btn btn-delete">
                <span>ðŸ—‘ï¸</span> Delete
              </button>
              <button onClick={onCancel} className="btn" style={{ background: 'linear-gradient(135deg, #7f8c8d 0%, #34495e 100%)' }}>
                <span>â†©ï¸</span> Cancel
              </button>
            </div>
          </div>
        </div>
      );
    }
    
    // ================= CHANGE PASSWORD MODAL =================
    function ChangePasswordModal({ onChange, onCancel, data, setData, helpers }) {
      const [validation, setValidation] = React.useState({ valid: true, message: '' });
      
      const handleNewPasswordChange = (e) => {
        const newPassword = e.target.value;
        setData({ ...data, newPassword });
        
        if (newPassword.length > 0) {
          const validationResult = helpers.validatePassword(newPassword);
          setValidation(validationResult);
        } else {
          setValidation({ valid: true, message: '' });
        }
      };
      
      return (
        <div className="modal-overlay">
          <div className="modal">
            <h3><span className="gradient-text">ðŸ”’</span> Change Password</h3>
            
            <div className="form-group">
              <label>Current Password</label>
              <input
                type="password"
                className="form-control"
                placeholder="Enter current password"
                value={data.currentPassword}
                onChange={(e) => setData({ ...data, currentPassword: e.target.value })}
                required
              />
            </div>
            
            <div className="form-group">
              <label>New Password</label>
              <input
                type="password"
                className="form-control"
                placeholder="Enter new password"
                value={data.newPassword}
                onChange={handleNewPasswordChange}
                required
              />
              {data.newPassword && (
                <div style={{ 
                  marginTop: '5px', 
                  fontSize: '12px',
                  color: validation.valid ? '#2ecc71' : '#e74c3c',
                  fontWeight: '600'
                }}>
                  {validation.message}
                </div>
              )}
            </div>
            
            <div className="form-group">
              <label>Confirm New Password</label>
              <input
                type="password"
                className="form-control"
                placeholder="Confirm new password"
                value={data.confirmPassword}
                onChange={(e) => setData({ ...data, confirmPassword: e.target.value })}
                required
              />
              {data.confirmPassword && data.newPassword !== data.confirmPassword && (
                <div style={{ marginTop: '5px', fontSize: '12px', color: '#e74c3c', fontWeight: '600' }}>
                  Passwords do not match
                </div>
              )}
            </div>
            
            <div style={{ display: 'flex', gap: '10px', marginTop: '25px' }}>
              <button 
                onClick={onChange} 
                className="btn"
                disabled={!validation.valid || data.newPassword !== data.confirmPassword}
              >
                <span>ðŸ’¾</span> Change Password
              </button>
              <button onClick={onCancel} className="btn" style={{ background: 'linear-gradient(135deg, #7f8c8d 0%, #34495e 100%)' }}>
                <span>â†©ï¸</span> Cancel
              </button>
            </div>
          </div>
        </div>
      );
    }
    
    // ================= RENDER APP =================
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>